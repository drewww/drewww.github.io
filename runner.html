<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
          
      @font-face {
          font-family: 'squaremodern';
          src: url('data:font/woff2;base64,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') format('woff2'),
              url('assets/webfont.woff') format('woff');
          font-weight: normal;
          font-style: normal;
      }

      h1 {
        font-family: squaremodern;
      }

    </style>

    <script>
      function downloadCanvas() {
        const canvas = document.querySelector('canvas');
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = image;
        link.download = 'runner-dev-' + Math.floor(Date.now() / 1000) + '.png';
        link.click();
      }

      function addDownloadButton(){
        const button = document.createElement('button');
        button.innerText = 'Download Canvas';
        button.style = "color: white; background-color: black; border: 0px";
        button.addEventListener('click', downloadCanvas);
        document.body.appendChild(button);
      };

    </script>
    <title>runner -- a cyberpunk escape roguelike</title>
    <script type="module" crossorigin>var ne=Object.defineProperty;var oe=(a,t,e)=>t in a?ne(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var _=(a,t,e)=>(oe(a,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const l of s)if(l.type==="childList")for(const r of l.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const l={};return s.integrity&&(l.integrity=s.integrity),s.referrerPolicy&&(l.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?l.credentials="include":s.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function i(s){if(s.ep)return;s.ep=!0;const l=e(s);fetch(s.href,l)}})();const at=23283064365386963e-26;class bt{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*at,t=t*69069+1>>>0,this._s1=t*at,t=t*69069+1>>>0,this._s2=t*at,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*at;return this._s0=this._s1,this._s1=this._s2,this._c=t|0,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,l;do i=2*this.getUniform()-1,s=2*this.getUniform()-1,l=i*i+s*s;while(l>1||l==0);let r=i*Math.sqrt(-2*Math.log(l)/l);return t+r*e}getPercentage(){return 1+Math.floor(this.getUniform()*100)}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let s=i.indexOf(this.getItem(i));e.push(i.splice(s,1)[0])}return e}getWeightedValue(t){let e=0;for(let r in t)e+=t[r];let i=this.getUniform()*e,s,l=0;for(s in t)if(l+=t[s],i<l)return s;return s}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return new bt().setState(this.getState())}}const x=new bt().setSeed(Date.now());class vt{getContainer(){return null}setOptions(t){this._options=t}}class Et extends vt{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const i=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=i,this._updateSize(),this._ctx.font=i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}function Tt(a,t){return(a%t+t)%t}function Bt(a,t=0,e=1){return a<t?t:a>e?e:a}class Ut extends Et{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,l,r,h]=t,n=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&n.reverse(),e&&(this._ctx.fillStyle=h,this._fill(n[0],n[1])),!l)return;this._ctx.fillStyle=r;let o=[].concat(l);for(let c=0;c<o.length;c++)this._ctx.fillText(o[c],n[0],Math.ceil(n[1]))}computeSize(t,e){this._options.transpose&&(t+=e,e=t-e,t-=e);let i=Math.floor(t/this._spacingX)-1,s=Math.floor((e-2*this._hexSize)/this._spacingY+1);return[i,s]}computeFontSize(t,e){this._options.transpose&&(t+=e,e=t-e,t-=e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),l=Math.min(i,s),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let h=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let n=h/100;l=Math.floor(l)+1;let o=2*l/(this._options.spacing*(1+n/Math.sqrt(3)));return Math.ceil(o)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,e=t-e,t-=e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return e=Math.floor(e/s),Tt(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const l=this._ctx;l.beginPath(),this._options.transpose?(l.moveTo(t-i+s,e),l.lineTo(t-i/2+s,e+this._spacingX-s),l.lineTo(t+i/2-s,e+this._spacingX-s),l.lineTo(t+i-s,e),l.lineTo(t+i/2-s,e-this._spacingX+s),l.lineTo(t-i/2+s,e-this._spacingX+s),l.lineTo(t-i+s,e)):(l.moveTo(t,e-i+s),l.lineTo(t+this._spacingX-s,e-i/2+s),l.lineTo(t+this._spacingX-s,e+i/2-s),l.lineTo(t,e+i-s),l.lineTo(t-this._spacingX+s,e+i/2-s),l.lineTo(t-this._spacingX+s,e-i/2+s),l.lineTo(t,e-i+s)),l.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=this._hexSize*1.5;let i,s;t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}let Ht=(()=>{class a extends Et{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(e){super.setOptions(e),this._canvasCache={}}draw(e,i){a.cache?this._drawWithCache(e):this._drawNoCache(e,i)}_drawWithCache(e){let[i,s,l,r,h]=e,n=""+l+r+h,o;if(n in this._canvasCache)o=this._canvasCache[n];else{let c=this._options.border;o=document.createElement("canvas");let u=o.getContext("2d");if(o.width=this._spacingX,o.height=this._spacingY,u.fillStyle=h,u.fillRect(c,c,o.width-c,o.height-c),l){u.fillStyle=r,u.font=this._ctx.font,u.textAlign="center",u.textBaseline="middle";let f=[].concat(l);for(let p=0;p<f.length;p++)u.fillText(f[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[n]=o}this._ctx.drawImage(o,i*this._spacingX,s*this._spacingY)}_drawNoCache(e,i){let[s,l,r,h,n]=e;if(i){let c=this._options.border;this._ctx.fillStyle=n,this._ctx.fillRect(s*this._spacingX+c,l*this._spacingY+c,this._spacingX-c,this._spacingY-c)}if(!r)return;this._ctx.fillStyle=h;let o=[].concat(r);for(let c=0;c<o.length;c++)this._ctx.fillText(o[c],(s+.5)*this._spacingX,Math.ceil((l+.5)*this._spacingY))}computeSize(e,i){let s=Math.floor(e/this._spacingX),l=Math.floor(i/this._spacingY);return[s,l]}computeFontSize(e,i){let s=Math.floor(e/this._options.width),l=Math.floor(i/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let h=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let o=h/100*l/s;return o>1&&(l=Math.floor(l/o)),Math.floor(l/this._options.spacing)}_normalizedEventToPosition(e,i){return[Math.floor(e/this._spacingX),Math.floor(i/this._spacingY)]}_updateSize(){const e=this._options,i=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(e.spacing*i),this._spacingY=Math.ceil(e.spacing*e.fontSize),e.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=e.width*this._spacingX,this._ctx.canvas.height=e.height*this._spacingY}}return a.cache=!1,a})(),Ft=class extends Et{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,l,r,h]=t,n=this._options.tileWidth,o=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*n,s*o,n,o):(this._ctx.fillStyle=h,this._ctx.fillRect(i*n,s*o,n,o))),!l)return;let c=[].concat(l),u=[].concat(r),f=[].concat(h);for(let p=0;p<c.length;p++){let g=this._options.tileMap[c[p]];if(!g)throw new Error(`Char "${c[p]}" not found in tileMap`);if(this._options.tileColorize){let y=this._colorCanvas,w=y.getContext("2d");w.globalCompositeOperation="source-over",w.clearRect(0,0,n,o);let v=u[p],R=f[p];w.drawImage(this._options.tileSet,g[0],g[1],n,o,0,0,n,o),v!="transparent"&&(w.fillStyle=v,w.globalCompositeOperation="source-atop",w.fillRect(0,0,n,o)),R!="transparent"&&(w.fillStyle=R,w.globalCompositeOperation="destination-over",w.fillRect(0,0,n,o)),this._ctx.drawImage(y,i*n,s*o,n,o)}else this._ctx.drawImage(this._options.tileSet,g[0],g[1],n,o,i*n,s*o,n,o)}}computeSize(t,e){let i=Math.floor(t/this._options.tileWidth),s=Math.floor(e/this._options.tileHeight);return[i,s]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}};function Mt(a){let t,e;if(a in gt)t=gt[a];else{if(a.charAt(0)=="#"){let s=(a.match(/[0-9a-f]/gi)||[]).map(l=>parseInt(l,16));if(s.length==3)t=s.map(l=>l*17);else{for(let l=0;l<3;l++)s[l+1]+=16*s[l],s.splice(l,1);t=s}}else(e=a.match(/rgb\(([0-9, ]+)\)/i))?t=e[1].split(/\s*,\s*/).map(i=>parseInt(i)):t=[0,0,0];gt[a]=t}return t.slice()}function ae(a,...t){let e=a.slice();for(let i=0;i<3;i++)for(let s=0;s<t.length;s++)e[i]+=t[s][i];return e}function ce(a,...t){for(let e=0;e<3;e++)for(let i=0;i<t.length;i++)a[e]+=t[i][e];return a}function ue(a,...t){let e=a.slice();for(let i=0;i<3;i++){for(let s=0;s<t.length;s++)e[i]*=t[s][i]/255;e[i]=Math.round(e[i])}return e}function fe(a,...t){for(let e=0;e<3;e++){for(let i=0;i<t.length;i++)a[e]*=t[i][e]/255;a[e]=Math.round(a[e])}return a}function Gt(a,t,e=.5){let i=a.slice();for(let s=0;s<3;s++)i[s]=Math.round(i[s]+e*(t[s]-a[s]));return i}const de=Gt;function Yt(a,t,e=.5){let i=wt(a),s=wt(t);for(let l=0;l<3;l++)i[l]+=e*(s[l]-i[l]);return $t(i)}const pe=Yt;function _e(a,t){t instanceof Array||(t=Math.round(x.getNormal(0,t)));let e=a.slice();for(let i=0;i<3;i++)e[i]+=t instanceof Array?Math.round(x.getNormal(0,t[i])):t;return e}function wt(a){let t=a[0]/255,e=a[1]/255,i=a[2]/255,s=Math.max(t,e,i),l=Math.min(t,e,i),r=0,h,n=(s+l)/2;if(s==l)h=0;else{let o=s-l;switch(h=n>.5?o/(2-s-l):o/(s+l),s){case t:r=(e-i)/o+(e<i?6:0);break;case e:r=(i-t)/o+2;break;case i:r=(t-e)/o+4;break}r/=6}return[r,h,n]}function _t(a,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?a+(t-a)*6*e:e<1/2?t:e<2/3?a+(t-a)*(2/3-e)*6:a}function $t(a){let t=a[2];if(a[1]==0)return t=Math.round(t*255),[t,t,t];{let e=a[1],i=t<.5?t*(1+e):t+e-t*e,s=2*t-i,l=_t(s,i,a[0]+1/3),r=_t(s,i,a[0]),h=_t(s,i,a[0]-1/3);return[Math.round(l*255),Math.round(r*255),Math.round(h*255)]}}function ge(a){return`rgb(${a.map(e=>Bt(e,0,255)).join(",")})`}function me(a){return`#${a.map(e=>Bt(e,0,255).toString(16).padStart(2,"0")).join("")}`}const gt={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]},ye=Object.freeze(Object.defineProperty({__proto__:null,add:ae,add_:ce,fromString:Mt,hsl2rgb:$t,interpolate:Gt,interpolateHSL:Yt,lerp:de,lerpHSL:pe,multiply:ue,multiply_:fe,randomize:_e,rgb2hsl:wt,toHex:me,toRGB:ge},Symbol.toStringTag,{value:"Module"}));class Xt extends vt{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){const i=this._gl,s=this._options;let[l,r,h,n,o]=t,c=i.canvas.height-(r+1)*s.tileHeight;if(i.scissor(l*s.tileWidth,c,s.tileWidth,s.tileHeight),e&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...ct(o)),i.clear(i.COLOR_BUFFER_BIT)),!h)return;let u=[].concat(h),f=[].concat(o),p=[].concat(n);i.uniform2fv(this._uniforms.targetPosRel,[l,r]);for(let g=0;g<u.length;g++){let y=this._options.tileMap[u[g]];if(!y)throw new Error(`Char "${u[g]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,y),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,ct(p[g])),i.uniform4fv(this._uniforms.bg,ct(f[g]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...ct(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){let i=Math.floor(t/this._options.tileWidth),s=Math.floor(e/this._options.tileHeight);return[i,s]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=be(t,we,xe);return t.useProgram(e),ve(t),Te.forEach(i=>this._uniforms[i]=t.getUniformLocation(e,i)),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){Ee(this._gl,t)}}const Te=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],we=`
#version 300 es

in vec2 tilePosRel;
out vec2 tilesetPosPx;

uniform vec2 tilesetPosAbs;
uniform vec2 tileSize;
uniform vec2 targetSize;
uniform vec2 targetPosRel;

void main() {
	vec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;
	vec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;
	targetPosNdc.y *= -1.0;

	gl_Position = vec4(targetPosNdc, 0.0, 1.0);
	tilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;
}`.trim(),xe=`
#version 300 es
precision highp float;

in vec2 tilesetPosPx;
out vec4 fragColor;
uniform sampler2D image;
uniform bool colorize;
uniform vec4 bg;
uniform vec4 tint;

void main() {
	fragColor = vec4(0, 0, 0, 1);

	vec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);

	if (colorize) {
		texel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;
		fragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;
		fragColor.a = texel.a + (1.0-texel.a)*bg.a;
	} else {
		fragColor = texel;
	}
}`.trim();function be(a,t,e){const i=a.createShader(a.VERTEX_SHADER);if(a.shaderSource(i,t),a.compileShader(i),!a.getShaderParameter(i,a.COMPILE_STATUS))throw new Error(a.getShaderInfoLog(i)||"");const s=a.createShader(a.FRAGMENT_SHADER);if(a.shaderSource(s,e),a.compileShader(s),!a.getShaderParameter(s,a.COMPILE_STATUS))throw new Error(a.getShaderInfoLog(s)||"");const l=a.createProgram();if(a.attachShader(l,i),a.attachShader(l,s),a.linkProgram(l),!a.getProgramParameter(l,a.LINK_STATUS))throw new Error(a.getProgramInfoLog(l)||"");return l}function ve(a){const t=new Float32Array([0,0,1,0,0,1,1,1]),e=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,e),a.bufferData(a.ARRAY_BUFFER,t,a.STATIC_DRAW),a.enableVertexAttribArray(0),a.vertexAttribPointer(0,2,a.FLOAT,!1,0,0)}function Ee(a,t){let e=a.createTexture();return a.bindTexture(a.TEXTURE_2D,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,a.NEAREST),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,a.REPEAT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,a.REPEAT),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,0),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,t),e}let mt={};function ct(a){if(!(a in mt)){let t;if(a=="transparent")t=[0,0,0,0];else if(a.indexOf("rgba")>-1){t=(a.match(/[\d.]+/g)||[]).map(Number);for(let e=0;e<3;e++)t[e]=t[e]/255}else t=Mt(a).map(e=>e/255),t.push(1);mt[a]=t}return mt[a]}function Me(a){return`\x1B[0;48;5;${xt(a)}m\x1B[2J`}function Re(a,t){return`\x1B[0;38;5;${xt(a)};48;5;${xt(t)}m`}function Le(a,t){return`\x1B[${t+1};${a+1}H`}function xt(a){const i=.0234375;let s=Mt(a),l=Math.floor(s[0]*i),r=Math.floor(s[1]*i),h=Math.floor(s[2]*i);return l*36+r*6+h*1+16}class jt extends vt{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((s,l)=>Math.floor((s-e[l])/2))}clear(){process.stdout.write(Me(this._options.bg))}draw(t,e){let[i,s,l,r,h]=t,n=this._offset[0]+i,o=this._offset[1]+s,c=this.computeSize();if(n<0||n>=c[0]||o<0||o>=c[1]||((n!==this._cursor[0]||o!==this._cursor[1])&&(process.stdout.write(Le(n,o)),this._cursor[0]=n,this._cursor[1]=o),e&&(l||(l=" ")),!l))return;let u=Re(r,h);if(u!==this._lastColor&&(process.stdout.write(u),this._lastColor=u),l!="	"){let f=[].concat(l);process.stdout.write(f[0])}this._cursor[0]++,this._cursor[0]>=c[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const Ce=/%([bc]){([^}]*)}/g,tt=0,ht=1,zt=2,qt=3;function Ae(a,t){let e=[],i=0;a.replace(Ce,function(l,r,h,n){let o=a.substring(i,n);return o.length&&e.push({type:tt,value:o}),e.push({type:r=="c"?zt:qt,value:h.trim()}),i=n+l.length,""});let s=a.substring(i);return s.length&&e.push({type:tt,value:s}),Oe(e,t)}function Oe(a,t){t||(t=1/0);let e=0,i=0,s=-1;for(;e<a.length;){let r=a[e];if(r.type==ht&&(i=0,s=-1),r.type!=tt){e++;continue}for(;i==0&&r.value.charAt(0)==" ";)r.value=r.value.substring(1);let h=r.value.indexOf(`
`);if(h!=-1){r.value=ut(a,e,h,!0);let n=r.value.split("");for(;n.length&&n[n.length-1]==" ";)n.pop();r.value=n.join("")}if(!r.value.length){a.splice(e,1);continue}if(i+r.value.length>t){let n=-1;for(;;){let o=r.value.indexOf(" ",n+1);if(o==-1||i+o>t)break;n=o}if(n!=-1)r.value=ut(a,e,n,!0);else if(s!=-1){let o=a[s],c=o.value.lastIndexOf(" ");o.value=ut(a,s,c,!0),e=s}else r.value=ut(a,e,t-i,!1)}else i+=r.value.length,r.value.indexOf(" ")!=-1&&(s=e);e++}a.push({type:ht});let l=null;for(let r=0;r<a.length;r++){let h=a[r];switch(h.type){case tt:l=h;break;case ht:if(l){let n=l.value.split("");for(;n.length&&n[n.length-1]==" ";)n.pop();l.value=n.join("")}l=null;break}}return a.pop(),a}function ut(a,t,e,i){let s={type:ht},l={type:tt,value:a[t].value.substring(e+(i?1:0))};return a.splice(t+1,0,s,l),a[t].value.substring(0,e)}let Jt=80,Qt=25;const P={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},M={VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95},Ie={hex:Ut,rect:Ht,tile:Ft,"tile-gl":Xt,term:jt},Se={width:Jt,height:Qt,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};let Ne=(()=>{class a{constructor(e={}){this._data={},this._dirty=!1,this._options={},e=Object.assign({},Se,e),this.setOptions(e),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(e,i,s){let l=[this._options.bg,this._options.fg];this.draw(e,i,null,null,l[s%l.length])}clear(){this._data={},this._dirty=!0}setOptions(e){if(Object.assign(this._options,e),e.width||e.height||e.fontSize||e.fontFamily||e.spacing||e.layout){if(e.layout){let i=Ie[e.layout];this._backend=new i}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(e,i){return this._backend.computeSize(e,i)}computeFontSize(e,i){return this._backend.computeFontSize(e,i)}computeTileSize(e,i){let s=Math.floor(e/this._options.width),l=Math.floor(i/this._options.height);return[s,l]}eventToPosition(e){let i,s;return"touches"in e?(i=e.touches[0].clientX,s=e.touches[0].clientY):(i=e.clientX,s=e.clientY),this._backend.eventToPosition(i,s)}draw(e,i,s,l,r){l||(l=this._options.fg),r||(r=this._options.bg);let h=`${e},${i}`;this._data[h]=[e,i,s,l,r],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[h]=!0)}drawOver(e,i,s,l,r){const h=`${e},${i}`,n=this._data[h];n?(n[2]=s||n[2],n[3]=l||n[3],n[4]=r||n[4]):this.draw(e,i,s,l,r)}drawText(e,i,s,l){let r=null,h=null,n=e,o=i,c=1;l||(l=this._options.width-e);let u=Ae(s,l);for(;u.length;){let f=u.shift();switch(f.type){case tt:let p=!1,g=!1,y=!1,w=!1;for(let v=0;v<f.value.length;v++){let R=f.value.charCodeAt(v),I=f.value.charAt(v);if(this._options.layout==="term"){let S=R>>8;if(S===17||S>=46&&S<=159||S>=172&&S<=215||R>=43360&&R<=43391){this.draw(n+0,o,I,r,h),this.draw(n+1,o,"	",r,h),n+=2;continue}}y=R>65280&&R<65377||R>65500&&R<65512||R>65518,p=I.charCodeAt(0)==32||I.charCodeAt(0)==12288,w&&!y&&!p&&n++,y&&!g&&n++,this.draw(n++,o,I,r,h),g=p,w=y}break;case zt:r=f.value||null;break;case qt:h=f.value||null;break;case ht:n=e,o++,c++;break}}return c}_tick(){if(this._backend.schedule(this._tick),!!this._dirty){if(this._dirty===!0){this._backend.clear();for(let e in this._data)this._draw(e,!1)}else for(let e in this._dirty)this._draw(e,!0);this._dirty=!1}}_draw(e,i){let s=this._data[e];s[4]!=this._options.bg&&(i=!0),this._backend.draw(s,i)}}return a.Rect=Ht,a.Hex=Ut,a.Tile=Ft,a.TileGL=Xt,a.Term=jt,a})();class St{constructor(){this.heap=[],this.timestamp=0}lessThan(t,e){return t.key==e.key?t.timestamp<e.timestamp:t.key<e.key}shift(t){this.heap=this.heap.map(({key:e,value:i,timestamp:s})=>({key:e+t,value:i,timestamp:s}))}len(){return this.heap.length}push(t,e){this.timestamp+=1;const i=this.len();this.heap.push({value:t,timestamp:this.timestamp,key:e}),this.updateUp(i)}pop(){if(this.len()==0)throw new Error("no element to pop");const t=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),t}find(t){for(let e=0;e<this.len();e++)if(t==this.heap[e].value)return this.heap[e];return null}remove(t){let e=null;for(let i=0;i<this.len();i++)t==this.heap[i].value&&(e=i);if(e===null)return!1;if(this.len()>1){let i=this.heap.pop();return i.value!=t&&(this.heap[e]=i,this.updateDown(e)),!0}else this.heap.pop();return!0}parentNode(t){return Math.floor((t-1)/2)}leftChildNode(t){return 2*t+1}rightChildNode(t){return 2*t+2}existNode(t){return t>=0&&t<this.heap.length}swap(t,e){const i=this.heap[t];this.heap[t]=this.heap[e],this.heap[e]=i}minNode(t){const e=t.filter(this.existNode.bind(this));let i=e[0];for(const s of e)this.lessThan(this.heap[s],this.heap[i])&&(i=s);return i}updateUp(t){if(t==0)return;const e=this.parentNode(t);this.existNode(e)&&this.lessThan(this.heap[t],this.heap[e])&&(this.swap(t,e),this.updateUp(e))}updateDown(t){const e=this.leftChildNode(t),i=this.rightChildNode(t);if(!this.existNode(e))return;const s=this.minNode([t,e,i]);s!=t&&(this.swap(t,s),this.updateDown(s))}debugPrint(){console.log(this.heap)}}class Pe{constructor(){this._time=0,this._events=new St}getTime(){return this._time}clear(){return this._events=new St,this}add(t,e){this._events.push(t,e)}get(){if(!this._events.len())return null;let{key:t,value:e}=this._events.pop();return t>0&&(this._time+=t,this._events.shift(-t)),e}getEventTime(t){const e=this._events.find(t);if(e){const{key:i}=e;return i}}remove(t){return this._events.remove(t)}}class Rt{constructor(){this._queue=new Pe,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return i!=-1&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}class ke extends Rt{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,0),super.next()}}class Ke extends Rt{add(t,e,i){return this._queue.add(t,i!==void 0?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}}class Ve extends Rt{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}const We={Simple:ke,Speed:Ke,Action:Ve};class Lt{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s=[],l,r,h;switch(this._options.topology){case 4:r=1,h=[0,1],l=[P[8][7],P[8][1],P[8][3],P[8][5]];break;case 6:l=P[6],r=1,h=[-1,1];break;case 8:l=P[4],r=2,h=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let n=t+h[0]*i,o=e+h[1]*i;for(let c=0;c<l.length;c++)for(let u=0;u<i*r;u++)s.push([n,o]),n+=l[c][0],o+=l[c][1];return s}}class De extends Lt{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let l=[],r,h,n,o,c;for(let u=1;u<=i;u++){let f=this._getCircle(t,e,u),p=360/f.length;for(let g=0;g<f.length;g++)if(n=f[g][0],o=f[g][1],r=p*(g-.5),h=r+p,c=!this._lightPasses(n,o),this._visibleCoords(Math.floor(r),Math.ceil(h),c,l)&&s(n,o,u,1),l.length==2&&l[0]==0&&l[1]==360)return}}_visibleCoords(t,e,i,s){if(t<0){let h=this._visibleCoords(0,e,i,s),n=this._visibleCoords(360+t,360,i,s);return h||n}let l=0;for(;l<s.length&&s[l]<t;)l++;if(l==s.length)return i&&s.push(t,e),!0;let r=0;if(l%2){for(;l<s.length&&s[l]<e;)l++,r++;return r==0?!1:(i&&(r%2?s.splice(l-r,r,e):s.splice(l-r,r)),!0)}else{for(;l<s.length&&s[l]<e;)l++,r++;return t==s[l-r]&&r==1?!1:(i&&(r%2?s.splice(l-r,r,t):s.splice(l-r,r,t,e)),!0)}}}class Be extends Lt{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let l=[],r,h,n,o,c,u;for(let f=1;f<=i;f++){let p=this._getCircle(t,e,f),g=p.length;for(let y=0;y<g;y++)if(r=p[y][0],h=p[y][1],o=[y?2*y-1:2*g-1,2*g],c=[2*y+1,2*g],n=!this._lightPasses(r,h),u=this._checkVisibility(o,c,n,l),u&&s(r,h,f,u),l.length==2&&l[0][0]==0&&l[1][0]==l[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0]){let p=this._checkVisibility(t,[t[1],t[1]],i,s),g=this._checkVisibility([0,1],e,i,s);return(p+g)/2}let l=0,r=!1;for(;l<s.length;){let p=s[l],g=p[0]*t[1]-t[0]*p[1];if(g>=0){g==0&&!(l%2)&&(r=!0);break}l++}let h=s.length,n=!1;for(;h--;){let p=s[h],g=e[0]*p[1]-p[0]*e[1];if(g>=0){g==0&&h%2&&(n=!0);break}}let o=!0;if((l==h&&(r||n)||r&&n&&l+1==h&&h%2||l>h&&l%2)&&(o=!1),!o)return 0;let c,u=h-l+1;if(u%2)if(l%2){let p=s[l];c=(e[0]*p[1]-p[0]*e[1])/(p[1]*e[1]),i&&s.splice(l,u,e)}else{let p=s[h];c=(p[0]*t[1]-t[0]*p[1])/(t[1]*p[1]),i&&s.splice(l,u,t)}else if(l%2){let p=s[l],g=s[h];c=(g[0]*p[1]-p[0]*g[1])/(p[1]*g[1]),i&&s.splice(l,u)}else return i&&s.splice(l,u,t,e),1;let f=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]);return c/f}}const $=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];class Ue extends Lt{compute(t,e,i,s){s(t,e,0,1);for(let l=0;l<$.length;l++)this._renderOctant(t,e,$[l],i,s)}compute180(t,e,i,s,l){l(t,e,0,1);let r=(s-1+8)%8,h=(s-2+8)%8,n=(s+1+8)%8;this._renderOctant(t,e,$[h],i,l),this._renderOctant(t,e,$[r],i,l),this._renderOctant(t,e,$[s],i,l),this._renderOctant(t,e,$[n],i,l)}compute90(t,e,i,s,l){l(t,e,0,1);let r=(s-1+8)%8;this._renderOctant(t,e,$[s],i,l),this._renderOctant(t,e,$[r],i,l)}_renderOctant(t,e,i,s,l){this._castVisibility(t,e,1,1,0,s+1,i[0],i[1],i[2],i[3],l)}_castVisibility(t,e,i,s,l,r,h,n,o,c,u){if(!(s<l))for(let f=i;f<=r;f++){let p=-f-1,g=-f,y=!1,w=0;for(;p<=0;){p+=1;let v=t+p*h+g*n,R=e+p*o+g*c,I=(p-.5)/(g+.5),S=(p+.5)/(g-.5);if(!(S>s)){if(I<l)break;if(p*p+g*g<r*r&&u(v,R,f,1),!y)!this._lightPasses(v,R)&&f<r&&(y=!0,this._castVisibility(t,e,f+1,s,I,r,h,n,o,c,u),w=S);else{if(!this._lightPasses(v,R)){w=S;continue}y=!1,s=w}}}if(y)break}}}const Zt={DiscreteShadowcasting:De,PreciseShadowcasting:Be,RecursiveShadowcasting:Ue};class J{constructor(t=Jt,e=Qt){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let s=0;s<this._height;s++)e[i].push(t)}return e}}class He extends J{create(t){let e=this._width-1,i=this._height-1;for(let s=0;s<=e;s++)for(let l=0;l<=i;l++){let r=s&&l&&s<e&&l<i;t(s,l,r?0:1)}return this}}class te extends J{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class ee{}class dt extends ee{constructor(t,e,i,s,l,r){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=s,this._doors={},l!==void 0&&r!==void 0&&this.addDoor(l,r)}static createRandomAt(t,e,i,s,l){let r=l.roomWidth[0],h=l.roomWidth[1],n=x.getUniformInt(r,h);r=l.roomHeight[0],h=l.roomHeight[1];let o=x.getUniformInt(r,h);if(i==1){let c=e-Math.floor(x.getUniform()*o);return new this(t+1,c,t+n,c+o-1,t,e)}if(i==-1){let c=e-Math.floor(x.getUniform()*o);return new this(t-n,c,t-1,c+o-1,t,e)}if(s==1){let c=t-Math.floor(x.getUniform()*n);return new this(c,e+1,c+n-1,e+o,t,e)}if(s==-1){let c=t-Math.floor(x.getUniform()*n);return new this(c,e-o,c+n-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let s=i.roomWidth[0],l=i.roomWidth[1],r=x.getUniformInt(s,l);s=i.roomHeight[0],l=i.roomHeight[1];let h=x.getUniformInt(s,l),n=t-Math.floor(x.getUniform()*r),o=e-Math.floor(x.getUniform()*h),c=n+r-1,u=o+h-1;return new this(n,o,c,u)}static createRandom(t,e,i){let s=i.roomWidth[0],l=i.roomWidth[1],r=x.getUniformInt(s,l);s=i.roomHeight[0],l=i.roomHeight[1];let h=x.getUniformInt(s,l),n=t-r-1,o=e-h-1,c=1+Math.floor(x.getUniform()*n),u=1+Math.floor(x.getUniform()*o),f=c+r-1,p=u+h-1;return new this(c,u,f,p)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,l=this._y2+1;for(let r=e;r<=i;r++)for(let h=s;h<=l;h++)r!=e&&r!=i&&h!=s&&h!=l||t(r,h)||this.addDoor(r,h);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,s=this._x2+1,l=this._y1-1,r=this._y2+1;for(let h=i;h<=s;h++)for(let n=l;n<=r;n++)if(h==i||h==s||n==l||n==r){if(!t(h,n))return!1}else if(!e(h,n))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,l=this._y2+1,r=0;for(let h=e;h<=i;h++)for(let n=s;n<=l;n++)h+","+n in this._doors?r=2:h==e||h==i||n==s||n==l?r=1:r=0,t(h,n,r)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class Ct extends ee{constructor(t,e,i,s){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=s,this._endsWithAWall=!0}static createRandomAt(t,e,i,s,l){let r=l.corridorLength[0],h=l.corridorLength[1],n=x.getUniformInt(r,h);return new this(t,e,t+i*n,e+s*n)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,s=this._startY,l=this._endX-i,r=this._endY-s,h=1+Math.max(Math.abs(l),Math.abs(r));l&&(l=l/Math.abs(l)),r&&(r=r/Math.abs(r));let n=r,o=-l,c=!0;for(let p=0;p<h;p++){let g=i+p*l,y=s+p*r;if(e(g,y)||(c=!1),t(g+n,y+o)||(c=!1),t(g-n,y-o)||(c=!1),!c){h=p,this._endX=g-l,this._endY=y-r;break}}if(h==0||h==1&&t(this._endX+l,this._endY+r))return!1;let u=!t(this._endX+l+n,this._endY+r+o),f=!t(this._endX+l-n,this._endY+r-o);return this._endsWithAWall=t(this._endX+l,this._endY+r),!((u||f)&&this._endsWithAWall)}create(t){let e=this._startX,i=this._startY,s=this._endX-e,l=this._endY-i,r=1+Math.max(Math.abs(s),Math.abs(l));s&&(s=s/Math.abs(s)),l&&(l=l/Math.abs(l));for(let h=0;h<r;h++){let n=e+h*s,o=i+h*l;t(n,o,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,s=this._endX-e,l=this._endY-i;s&&(s=s/Math.abs(s)),l&&(l=l/Math.abs(l));let r=l,h=-s;t(this._endX+s,this._endY+l),t(this._endX+r,this._endY+h),t(this._endX-r,this._endY-h)}}class Fe extends te{constructor(t,e,i){super(t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,i),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(t){let e=Date.now();for(;;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(let i=0;i<this._width;i++)for(let s=0;s<this._height;s++)t(i,s,this._map[i][s]);return this}_generateRooms(){let t=this._width-2,e=this._height-2,i;do if(i=this._generateRoom(),this._dug/(t*e)>this._options.roomDugPercentage)break;while(i)}_generateRoom(){let t=0;for(;t<this._roomAttempts;){t++;let e=dt.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null}_generateCorridors(){let t=0;for(;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(let e=0;e<this._rooms.length;e++){let i=this._rooms[e];i.clearDoors(),i.create(this._digCallback)}for(this._unconnected=x.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let e=x.getItem(this._connected);if(!e)break;let i=this._closestRoom(this._unconnected,e);if(!i)break;let s=this._closestRoom(this._connected,i);if(!s||!this._connectRooms(i,s))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(t,e){let i=1/0,s=e.getCenter(),l=null;for(let r=0;r<t.length;r++){let h=t[r],n=h.getCenter(),o=n[0]-s[0],c=n[1]-s[1],u=o*o+c*c;u<i&&(i=u,l=h)}return l}_connectRooms(t,e){let i=t.getCenter(),s=e.getCenter(),l=s[0]-i[0],r=s[1]-i[1],h,n,o,c,u,f,p;if(Math.abs(l)<Math.abs(r)?(o=r>0?2:0,c=(o+2)%4,u=e.getLeft(),f=e.getRight(),p=0):(o=l>0?1:3,c=(o+2)%4,u=e.getTop(),f=e.getBottom(),p=1),h=this._placeInWall(t,o),!h)return!1;if(h[p]>=u&&h[p]<=f){n=h.slice();let g=0;switch(c){case 0:g=e.getTop()-1;break;case 1:g=e.getRight()+1;break;case 2:g=e.getBottom()+1;break;case 3:g=e.getLeft()-1;break}n[(p+1)%2]=g,this._digLine([h,n])}else if(h[p]<u-1||h[p]>f+1){let g=h[p]-s[p],y=0;switch(c){case 0:case 1:y=g<0?3:1;break;case 2:case 3:y=g<0?1:3;break}if(c=(c+y)%4,n=this._placeInWall(e,c),!n)return!1;let w=[0,0];w[p]=h[p];let v=(p+1)%2;w[v]=n[v],this._digLine([h,w,n])}else{let g=(p+1)%2;if(n=this._placeInWall(e,c),!n)return!1;let y=Math.round((n[g]+h[g])/2),w=[0,0],v=[0,0];w[p]=h[p],w[g]=y,v[p]=n[p],v[g]=y,this._digLine([h,w,v,n])}return t.addDoor(h[0],h[1]),e.addDoor(n[0],n[1]),p=this._unconnected.indexOf(t),p!=-1&&(this._unconnected.splice(p,1),this._connected.push(t)),p=this._unconnected.indexOf(e),p!=-1&&(this._unconnected.splice(p,1),this._connected.push(e)),!0}_placeInWall(t,e){let i=[0,0],s=[0,0],l=0;switch(e){case 0:s=[1,0],i=[t.getLeft(),t.getTop()-1],l=t.getRight()-t.getLeft()+1;break;case 1:s=[0,1],i=[t.getRight()+1,t.getTop()],l=t.getBottom()-t.getTop()+1;break;case 2:s=[1,0],i=[t.getLeft(),t.getBottom()+1],l=t.getRight()-t.getLeft()+1;break;case 3:s=[0,1],i=[t.getLeft()-1,t.getTop()],l=t.getBottom()-t.getTop()+1;break}let r=[],h=-2;for(let n=0;n<l;n++){let o=i[0]+n*s[0],c=i[1]+n*s[1];r.push(null),this._map[o][c]==1?h!=n-1&&(r[n]=[o,c]):(h=n,n&&(r[n-1]=null))}for(let n=r.length-1;n>=0;n--)r[n]||r.splice(n,1);return r.length?x.getItem(r):null}_digLine(t){for(let e=1;e<t.length;e++){let i=t[e-1],s=t[e],l=new Ct(i[0],i[1],s[0],s[1]);l.create(this._digCallback),this._corridors.push(l)}}_digCallback(t,e,i){this._map[t][e]=i,i==0&&this._dug++}_isWallCallback(t,e){return t<0||e<0||t>=this._width||e>=this._height?!1:this._map[t][e]==1}_canBeDugCallback(t,e){return t<1||e<1||t+1>=this._width||e+1>=this._height?!1:this._map[t][e]==1}}class Ge extends J{constructor(t,e,i={}){super(t,e),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(i),this._dirs=P[this._options.topology],this._map=this._fillMap(0)}randomize(t){for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)this._map[e][i]=x.getUniform()<t?1:0;return this}setOptions(t){Object.assign(this._options,t)}set(t,e,i){this._map[t][e]=i}create(t){let e=this._fillMap(0),i=this._options.born,s=this._options.survive;for(let l=0;l<this._height;l++){let r=1,h=0;this._options.topology==6&&(r=2,h=l%2);for(let n=h;n<this._width;n+=r){let o=this._map[n][l],c=this._getNeighbors(n,l);(o&&s.indexOf(c)!=-1||!o&&i.indexOf(c)!=-1)&&(e[n][l]=1)}}this._map=e,t&&this._serviceCallback(t)}_serviceCallback(t){for(let e=0;e<this._height;e++){let i=1,s=0;this._options.topology==6&&(i=2,s=e%2);for(let l=s;l<this._width;l+=i)t(l,e,this._map[l][e])}}_getNeighbors(t,e){let i=0;for(let s=0;s<this._dirs.length;s++){let l=this._dirs[s],r=t+l[0],h=e+l[1];r<0||r>=this._width||h<0||h>=this._height||(i+=this._map[r][h]==1?1:0)}return i}connect(t,e,i){e||(e=0);let s=[],l={},r=1,h=[0,0];this._options.topology==6&&(r=2,h=[0,1]);for(let u=0;u<this._height;u++)for(let f=h[u%2];f<this._width;f+=r)if(this._freeSpace(f,u,e)){let p=[f,u];l[this._pointKey(p)]=p,s.push([f,u])}let n=s[x.getUniformInt(0,s.length-1)],o=this._pointKey(n),c={};for(c[o]=n,delete l[o],this._findConnected(c,l,[n],!1,e);Object.keys(l).length>0;){let u=this._getFromTo(c,l),f=u[0],p=u[1],g={};g[this._pointKey(f)]=f,this._findConnected(g,l,[f],!0,e),(this._options.topology==6?this._tunnelToConnected6:this._tunnelToConnected).call(this,p,f,c,l,e,i);for(let w in g){let v=g[w];this._map[v[0]][v[1]]=e,c[w]=v,delete l[w]}}t&&this._serviceCallback(t)}_getFromTo(t,e){let i=[0,0],s=[0,0],l,r=Object.keys(t),h=Object.keys(e);for(let n=0;n<5;n++){if(r.length<h.length){let o=r;s=t[o[x.getUniformInt(0,o.length-1)]],i=this._getClosest(s,e)}else{let o=h;i=e[o[x.getUniformInt(0,o.length-1)]],s=this._getClosest(i,t)}if(l=(i[0]-s[0])*(i[0]-s[0])+(i[1]-s[1])*(i[1]-s[1]),l<64)break}return[i,s]}_getClosest(t,e){let i=null,s=null;for(let l in e){let r=e[l],h=(r[0]-t[0])*(r[0]-t[0])+(r[1]-t[1])*(r[1]-t[1]);(s==null||h<s)&&(s=h,i=r)}return i}_findConnected(t,e,i,s,l){for(;i.length>0;){let r=i.splice(0,1)[0],h;this._options.topology==6?h=[[r[0]+2,r[1]],[r[0]+1,r[1]-1],[r[0]-1,r[1]-1],[r[0]-2,r[1]],[r[0]-1,r[1]+1],[r[0]+1,r[1]+1]]:h=[[r[0]+1,r[1]],[r[0]-1,r[1]],[r[0],r[1]+1],[r[0],r[1]-1]];for(let n=0;n<h.length;n++){let o=this._pointKey(h[n]);t[o]==null&&this._freeSpace(h[n][0],h[n][1],l)&&(t[o]=h[n],s||delete e[o],i.push(h[n]))}}}_tunnelToConnected(t,e,i,s,l,r){let h,n;e[0]<t[0]?(h=e,n=t):(h=t,n=e);for(let c=h[0];c<=n[0];c++){this._map[c][h[1]]=l;let u=[c,h[1]],f=this._pointKey(u);i[f]=u,delete s[f]}r&&h[0]<n[0]&&r(h,[n[0],h[1]]);let o=n[0];e[1]<t[1]?(h=e,n=t):(h=t,n=e);for(let c=h[1];c<n[1];c++){this._map[o][c]=l;let u=[o,c],f=this._pointKey(u);i[f]=u,delete s[f]}r&&h[1]<n[1]&&r([n[0],h[1]],[n[0],n[1]])}_tunnelToConnected6(t,e,i,s,l,r){let h,n;e[0]<t[0]?(h=e,n=t):(h=t,n=e);let o=h[0],c=h[1];for(;!(o==n[0]&&c==n[1]);){let u=2;c<n[1]?(c++,u=1):c>n[1]&&(c--,u=1),o<n[0]?o+=u:o>n[0]||n[1]%2?o-=u:o+=u,this._map[o][c]=l;let f=[o,c],p=this._pointKey(f);i[p]=f,delete s[p]}r&&r(e,t)}_freeSpace(t,e,i){return t>=0&&t<this._width&&e>=0&&e<this._height&&this._map[t][e]==i}_pointKey(t){return t[0]+"."+t[1]}}const Ye={room:dt,corridor:Ct};class $e extends te{constructor(t,e,i={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let i=Date.now(),s;do{if(s=0,Date.now()-i>this._options.timeLimit)break;let r=this._findWall();if(!r)break;let h=r.split(","),n=parseInt(h[0]),o=parseInt(h[1]),c=this._getDiggingDirection(n,o);if(!c)continue;let u=0;do if(u++,this._tryFeature(n,o,c[0],c[1])){this._removeSurroundingWalls(n,o),this._removeSurroundingWalls(n-c[0],o-c[1]);break}while(u<this._featureAttempts);for(let f in this._walls)this._walls[f]>1&&s++}while(this._dug/e<this._options.dugPercentage||s);if(this._addDoors(),t)for(let l=0;l<this._width;l++)for(let r=0;r<this._height;r++)t(l,r,this._map[l][r]);return this._walls={},this._map=[],this}_digCallback(t,e,i){i==0||i==2?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return t<0||e<0||t>=this._width||e>=this._height?!1:this._map[t][e]==1}_canBeDugCallback(t,e){return t<1||e<1||t+1>=this._width||e+1>=this._height?!1:this._map[t][e]==1}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=dt.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)}_findWall(){let t=[],e=[];for(let l in this._walls)this._walls[l]==2?e.push(l):t.push(l);let i=e.length?e:t;if(!i.length)return null;let s=x.getItem(i.sort());return delete this._walls[s],s}_tryFeature(t,e,i,s){let l=x.getWeightedValue(this._features),h=Ye[l].createRandomAt(t,e,i,s,this._options);return h.isValid(this._isWallCallback,this._canBeDugCallback)?(h.create(this._digCallback),h instanceof dt&&this._rooms.push(h),h instanceof Ct&&(h.createPriorityWalls(this._priorityWallCallback),this._corridors.push(h)),!0):!1}_removeSurroundingWalls(t,e){let i=P[4];for(let s=0;s<i.length;s++){let l=i[s],r=t+l[0],h=e+l[1];delete this._walls[r+","+h],r=t+2*l[0],h=e+2*l[1],delete this._walls[r+","+h]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let i=null,s=P[4];for(let l=0;l<s.length;l++){let r=s[l],h=t+r[0],n=e+r[1];if(!this._map[h][n]){if(i)return null;i=r}}return i?[-i[0],-i[1]]:null}_addDoors(){let t=this._map;function e(i,s){return t[i][s]==1}for(let i=0;i<this._rooms.length;i++){let s=this._rooms[i];s.clearDoors(),s.addDoors(e)}}}function Nt(a,t,e){e[t[a+1]]=e[a],t[e[a]]=t[a+1],e[a]=a+1,t[a+1]=a}function Pt(a,t,e){e[t[a]]=e[a],t[e[a]]=t[a],e[a]=a,t[a]=a}class Xe extends J{create(t){let e=this._fillMap(1),i=Math.ceil((this._width-2)/2),s=9/24,l=[],r=[];for(let n=0;n<i;n++)l.push(n),r.push(n);l.push(i-1);let h;for(h=1;h+3<this._height;h+=2)for(let n=0;n<i;n++){let o=2*n+1,c=h;e[o][c]=0,n!=l[n+1]&&x.getUniform()>s&&(Nt(n,l,r),e[o+1][c]=0),n!=l[n]&&x.getUniform()>s?Pt(n,l,r):e[o][c+1]=0}for(let n=0;n<i;n++){let o=2*n+1,c=h;e[o][c]=0,n!=l[n+1]&&(n==l[n]||x.getUniform()>s)&&(Nt(n,l,r),e[o+1][c]=0),Pt(n,l,r)}for(let n=0;n<this._width;n++)for(let o=0;o<this._height;o++)t(n,o,e[n][o]);return this}}class je extends J{constructor(){super(...arguments),this._stack=[],this._map=[]}create(t){let e=this._width,i=this._height;this._map=[];for(let s=0;s<e;s++){this._map.push([]);for(let l=0;l<i;l++){let r=s==0||l==0||s+1==e||l+1==i;this._map[s].push(r?1:0)}}this._stack=[[1,1,e-2,i-2]],this._process();for(let s=0;s<e;s++)for(let l=0;l<i;l++)t(s,l,this._map[s][l]);return this._map=[],this}_process(){for(;this._stack.length;){let t=this._stack.shift();this._partitionRoom(t)}}_partitionRoom(t){let e=[],i=[];for(let o=t[0]+1;o<t[2];o++){let c=this._map[o][t[1]-1],u=this._map[o][t[3]+1];c&&u&&!(o%2)&&e.push(o)}for(let o=t[1]+1;o<t[3];o++){let c=this._map[t[0]-1][o],u=this._map[t[2]+1][o];c&&u&&!(o%2)&&i.push(o)}if(!e.length||!i.length)return;let s=x.getItem(e),l=x.getItem(i);this._map[s][l]=1;let r=[],h=[];r.push(h);for(let o=t[0];o<s;o++)this._map[o][l]=1,o%2&&h.push([o,l]);h=[],r.push(h);for(let o=s+1;o<=t[2];o++)this._map[o][l]=1,o%2&&h.push([o,l]);h=[],r.push(h);for(let o=t[1];o<l;o++)this._map[s][o]=1,o%2&&h.push([s,o]);h=[],r.push(h);for(let o=l+1;o<=t[3];o++)this._map[s][o]=1,o%2&&h.push([s,o]);let n=x.getItem(r);for(let o=0;o<r.length;o++){let c=r[o];if(c==n)continue;let u=x.getItem(c);this._map[u[0]][u[1]]=0}this._stack.push([t[0],t[1],s-1,l-1]),this._stack.push([s+1,t[1],t[2],l-1]),this._stack.push([t[0],l+1,s-1,t[3]]),this._stack.push([s+1,l+1,t[2],t[3]])}}class ze extends J{constructor(t,e,i=0){super(t,e),this._regularity=i,this._map=[]}create(t){let e=this._width,i=this._height,s=this._fillMap(1);e-=e%2?1:2,i-=i%2?1:2;let l=0,r=0,h=0,n=0,o=0,c=!1,u=[[0,0],[0,0],[0,0],[0,0]];do if(l=1+2*Math.floor(x.getUniform()*(e-1)/2),r=1+2*Math.floor(x.getUniform()*(i-1)/2),o||(s[l][r]=0),!s[l][r]){this._randomize(u);do{Math.floor(x.getUniform()*(this._regularity+1))==0&&this._randomize(u),c=!0;for(let f=0;f<4;f++)if(h=l+u[f][0]*2,n=r+u[f][1]*2,this._isFree(s,h,n,e,i)){s[h][n]=0,s[l+u[f][0]][r+u[f][1]]=0,l=h,r=n,c=!1,o++;break}}while(!c)}while(o+1<e*i/4);for(let f=0;f<this._width;f++)for(let p=0;p<this._height;p++)t(f,p,s[f][p]);return this._map=[],this}_randomize(t){for(let e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(x.getUniform()*4)){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1;break}}_isFree(t,e,i,s,l){return e<1||i<1||e>=s||i>=l?!1:t[e][i]}}class qe extends J{constructor(t,e,i){super(t,e),this.map=[],this.rooms=[],this.connectedCells=[],i=Object.assign({cellWidth:3,cellHeight:3},i),i.hasOwnProperty("roomWidth")||(i.roomWidth=this._calculateRoomSize(this._width,i.cellWidth)),i.hasOwnProperty("roomHeight")||(i.roomHeight=this._calculateRoomSize(this._height,i.cellHeight)),this._options=i}create(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this}_calculateRoomSize(t,e){let i=Math.floor(t/e*.8),s=Math.floor(t/e*.25);return s<2&&(s=2),i<2&&(i=2),[s,i]}_initRooms(){for(let t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(let e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}}_connectRooms(){let t=x.getUniformInt(0,this._options.cellWidth-1),e=x.getUniformInt(0,this._options.cellHeight-1),i,s,l,r=!1,h,n,o;do{o=[0,2,4,6],o=x.shuffle(o);do if(r=!1,i=o.pop(),s=t+P[8][i][0],l=e+P[8][i][1],!(s<0||s>=this._options.cellWidth)&&!(l<0||l>=this._options.cellHeight)){if(h=this.rooms[t][e],h.connections.length>0&&h.connections[0][0]==s&&h.connections[0][1]==l)break;n=this.rooms[s][l],n.connections.length==0&&(n.connections.push([t,e]),this.connectedCells.push([s,l]),t=s,e=l,r=!0)}while(o.length>0&&r==!1)}while(o.length>0)}_connectUnconnectedRooms(){let t=this._options.cellWidth,e=this._options.cellHeight;this.connectedCells=x.shuffle(this.connectedCells);let i,s,l;for(let r=0;r<this._options.cellWidth;r++)for(let h=0;h<this._options.cellHeight;h++)if(i=this.rooms[r][h],i.connections.length==0){let n=[0,2,4,6];n=x.shuffle(n),l=!1;do{let o=n.pop(),c=r+P[8][o][0],u=h+P[8][o][1];if(!(c<0||c>=t||u<0||u>=e)){if(s=this.rooms[c][u],l=!0,s.connections.length==0)break;for(let f=0;f<s.connections.length;f++)if(s.connections[f][0]==r&&s.connections[f][1]==h){l=!1;break}if(l)break}}while(n.length);l?i.connections.push([s.cellx,s.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){let t=this._width,e=this._height,i=this._options.cellWidth,s=this._options.cellHeight,l=Math.floor(this._width/i),r=Math.floor(this._height/s),h,n,o=this._options.roomWidth,c=this._options.roomHeight,u,f,p;for(let g=0;g<i;g++)for(let y=0;y<s;y++){if(u=l*g,f=r*y,u==0&&(u=1),f==0&&(f=1),h=x.getUniformInt(o[0],o[1]),n=x.getUniformInt(c[0],c[1]),y>0)for(p=this.rooms[g][y-1];f-(p.y+p.height)<3;)f++;if(g>0)for(p=this.rooms[g-1][y];u-(p.x+p.width)<3;)u++;let w=Math.round(x.getUniformInt(0,l-h)/2),v=Math.round(x.getUniformInt(0,r-n)/2);for(;u+w+h>=t;)w?w--:h--;for(;f+v+n>=e;)v?v--:n--;u=u+w,f=f+v,this.rooms[g][y].x=u,this.rooms[g][y].y=f,this.rooms[g][y].width=h,this.rooms[g][y].height=n;for(let R=u;R<u+h;R++)for(let I=f;I<f+n;I++)this.map[R][I]=0}}_getWallPosition(t,e){let i,s,l;return e==1||e==3?(i=x.getUniformInt(t.x+1,t.x+t.width-2),e==1?(s=t.y-2,l=s+1):(s=t.y+t.height+1,l=s-1),this.map[i][l]=0):(s=x.getUniformInt(t.y+1,t.y+t.height-2),e==2?(i=t.x+t.width+1,l=i-1):(i=t.x-2,l=i+1),this.map[l][s]=0),[i,s]}_drawCorridor(t,e){let i=e[0]-t[0],s=e[1]-t[1],l=t[0],r=t[1],h,n,o,c,u=[],f=Math.abs(i),p=Math.abs(s),g=x.getUniform(),y=g,w=1-g;for(n=i>0?2:6,o=s>0?4:0,f<p?(h=Math.ceil(p*y),u.push([o,h]),u.push([n,f]),h=Math.floor(p*w),u.push([o,h])):(h=Math.ceil(f*y),u.push([n,h]),u.push([o,p]),h=Math.floor(f*w),u.push([n,h])),this.map[l][r]=0;u.length>0;)for(c=u.pop();c[1]>0;)l+=P[8][c[0]][0],r+=P[8][c[0]][1],this.map[l][r]=0,c[1]=c[1]-1}_createCorridors(){let t=this._options.cellWidth,e=this._options.cellHeight,i,s,l,r,h;for(let n=0;n<t;n++)for(let o=0;o<e;o++){i=this.rooms[n][o];for(let c=0;c<i.connections.length;c++)s=i.connections[c],l=this.rooms[s[0]][s[1]],l.cellx>i.cellx?(r=2,h=4):l.cellx<i.cellx?(r=4,h=2):l.celly>i.celly?(r=3,h=1):(r=1,h=3),this._drawCorridor(this._getWallPosition(i,r),this._getWallPosition(l,h))}}}const Je={Arena:He,Uniform:Fe,Cellular:Ge,Digger:$e,EllerMaze:Xe,DividedMaze:je,IceyMaze:ze,Rogue:qe};class Qe{}const Ze=.5*(Math.sqrt(3)-1),rt=(3-Math.sqrt(3))/6;class ti extends Qe{constructor(t=256){super(),this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];let e=[];for(let i=0;i<t;i++)e.push(i);e=x.shuffle(e),this._perms=[],this._indexes=[];for(let i=0;i<2*t;i++)this._perms.push(e[i%t]),this._indexes.push(this._perms[i]%this._gradients.length)}get(t,e){let i=this._perms,s=this._indexes,l=i.length/2,r=0,h=0,n=0,o,c=(t+e)*Ze,u=Math.floor(t+c),f=Math.floor(e+c),p=(u+f)*rt,g=u-p,y=f-p,w=t-g,v=e-y,R,I;w>v?(R=1,I=0):(R=0,I=1);let S=w-R+rt,X=v-I+rt,Q=w-1+2*rt,G=v-1+2*rt,st=Tt(u,l),j=Tt(f,l),Y=.5-w*w-v*v;if(Y>=0){Y*=Y,o=s[st+i[j]];let T=this._gradients[o];r=Y*Y*(T[0]*w+T[1]*v)}let W=.5-S*S-X*X;if(W>=0){W*=W,o=s[st+R+i[j+I]];let T=this._gradients[o];h=W*W*(T[0]*S+T[1]*X)}let V=.5-Q*Q-G*G;if(V>=0){V*=V,o=s[st+1+i[j+1]];let T=this._gradients[o];n=V*V*(T[0]*Q+T[1]*G)}return 70*(r+h+n)}}const ei={Simplex:ti};let ie=class{constructor(t,e,i,s={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},s),this._dirs=P[this._options.topology],this._options.topology==8&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let s=0;s<this._dirs.length;s++){let l=this._dirs[s],r=t+l[0],h=e+l[1];this._passableCallback(r,h)&&i.push([r,h])}return i}};class ii extends ie{constructor(t,e,i,s){super(t,e,i,s),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let s=t+","+e;if(s in this._computed||this._compute(t,e),!(s in this._computed))return;let l=this._computed[s];for(;l;)i(l.x,l.y),l=l.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let s=this._getNeighbors(i.x,i.y);for(let l=0;l<s.length;l++){let r=s[l],h=r[0],n=r[1];h+","+n in this._computed||this._add(h,n,i)}}}_add(t,e,i){let s={x:t,y:e,prev:i};this._computed[t+","+e]=s,this._todo.push(s)}}class si extends ie{constructor(t,e,i,s={}){super(t,e,i,s),this._todo=[],this._done={}}compute(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){let l=this._todo.shift(),r=l.x+","+l.y;if(r in this._done)continue;if(this._done[r]=l,l.x==t&&l.y==e)break;let h=this._getNeighbors(l.x,l.y);for(let n=0;n<h.length;n++){let o=h[n],c=o[0],u=o[1];c+","+u in this._done||this._add(c,u,l)}}let s=this._done[t+","+e];if(s)for(;s;)i(s.x,s.y),s=s.prev}_add(t,e,i){let s=this._distance(t,e),l={x:t,y:e,prev:i,g:i?i.g+1:0,h:s},r=l.g+l.h;for(let h=0;h<this._todo.length;h++){let n=this._todo[h],o=n.g+n.h;if(r<o||r==o&&s<n.h){this._todo.splice(h,0,l);return}}this._todo.push(l)}_distance(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:let i=Math.abs(t-this._fromX),s=Math.abs(e-this._fromY);return s+Math.max(0,(i-s)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}}}const Z={Dijkstra:ii,AStar:si};class kt{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}const K=ye,d={WHITE:"#ffffff",DARK_GREY:"#111111",MID_GREY:"#505050",LIGHT_GREY:"#cccccc",BLACK:"#000000",RED:"#ff0000",GREEN:"#00ff00",LIGHT_GREEN:"#00BB00",DARK_GREEN:"#005500",FAINT_GREEN:"#00EE00",YELLOW:"#ffff00",LASER_RED:"#a81d12",MID_LASER_RED:"#c3120e",LIGHT_LASER_RED:"#fea7a1",INVISIBLE_TILE:"#333333",VISIBLE_WALL:"#999999",HEALTH_RED:"#ff0000",MOVE_BLUE:"#4444ff",MOVE_LIGHT_BLUE:"#8888ff",RAINBOW_0:"#ff0000",RAINBOW_1:"#ff7f00",RAINBOW_2:"#ffff00",RAINBOW_3:"#00ff00",RAINBOW_4:"#3333ff",RAINBOW_5:"#8b33ff",LIGHT_GOLD:"#ffcc00",GOLD:"#ffd700",BLACKS:["#030300","#020002","#020205","#040400","#010202","#050003","#101010"],WHITES:["#FDFDFF","#FAFFFE","#FCFDFA","#FCFAFF","#F8F8F8","#FBDFDF","#D0D0D0"]},F=70,U=40;var O=(a=>(a.CAVE="CAVE",a.DEBUG="DEBUG",a.RANDOM="RANDOM",a.BSP="BSP",a.EDGE_ROOM="EDGE_ROOM",a.TUTORIAL="TUTORIAL",a.INTRO="INTRO",a.VAULT="VAULT",a))(O||{}),N=(a=>(a.TITLE="TITLE",a.GAME="GAME",a.KILLSCREEN="KILLSCREEN",a.WINSCREEN="WINSCREEN",a.MAP_EXPLORE="MAP_EXPLORE",a.TUTORIAL="TUTORIAL",a))(N||{});function pt(a,t){for(let e=0;e<t;e++)a={x:-a.y,y:a.x};return a}class it{constructor(t=F,e=U){_(this,"elements");_(this,"width",F);_(this,"height",U);_(this,"x",0);_(this,"y",0);_(this,"disabled",!1);this.elements=[],this.width=t,this.height=e}draw(t,e=0,i=0,s=d.BLACK){for(const l of this.elements)l.draw(t,this.x+e,this.y+i,s)}handleEvent(t){}disable(){for(const t of this.elements)t.disable();this.disabled=!0}}class li extends it{constructor(){super()}draw(t,e=0,i=0){t.drawText(10+e+this.x,Math.floor(this.height/2)+i+this.y,`%c{${d.WHITE}}%b{${d.LASER_RED}}RUNNER TERMINATED`),t.drawText(12+e+this.x,Math.floor(this.height/2)+3+i+this.y,`%c{${d.LIGHT_GREY}%b{${d.BLACK}}press any key to reset`)}}class se{constructor(t,e,i,s){_(this,"w");_(this,"h");_(this,"x");_(this,"y");_(this,"disabled",!1);this.w=i,this.h=s,this.x=t,this.y=e}draw(t,e,i){}disable(){this.disabled=!0}}class B extends se{constructor(e,i,s,l,r,h=d.WHITE,n=d.BLACK,o=!1,c=0,u=100){super(e,i,s,l);_(this,"text");_(this,"fg");_(this,"bg");_(this,"animate");_(this,"counter");_(this,"startDelay");_(this,"delay");_(this,"disabled",!1);this.text=r,this.fg=h,this.bg=n,this.animate=o,this.counter=0,this.startDelay=c,this.delay=u}disable(){this.disabled=!0}draw(e,i,s){if(!this.disabled)if(super.draw(e,i,s),this.animate)this.startDelay>0?(setTimeout(this.draw.bind(this),this.startDelay,e,i,s),this.startDelay=0):(e.drawText(i+this.x,s+this.y,`%c{${this.fg}}%b{${this.bg}}${this.text.substring(0,this.counter+1)}`,this.w),this.counter++,this.counter<this.text.length&&setTimeout(this.draw.bind(this),this.delay,e,i,s));else{let l=`%c{${this.bg}}%b{${this.bg}}`;l+="-".repeat(Math.max(this.w-this.text.length,0)),e.drawText(i+this.x,s+this.y,`%c{${this.fg}}%b{${this.bg}}${this.text+l}`,this.w)}}}class ri extends it{constructor(){super(),this.elements.push(new B(10+this.x,Math.floor(this.height/2),20,5,"RUNNER ESCAPED",d.WHITE,d.LIGHT_GREEN,!0,0,50)),this.elements.push(new B(12+this.x,Math.floor(this.height/2)+3,20,5,"press any key to   reset",d.LIGHT_GREY,d.BLACK,!0,50*24,50))}draw(t,e=0,i=0){super.draw(t,e,i)}}class le{constructor(t,e,i,s,l){_(this,"level",null);_(this,"stunned",0);this.x=t,this.y=e,this.symbol=i,this.fg=s,this.bg=l}draw(t,e,i,s=d.BLACK){t.draw(this.x+e,this.y+i,this.symbol,this.fg,s)}stun(t){this.stunned=t}move(t,e){return!this.level||this.level.pointPassable(this.x+t,this.y+e)===!1?!1:(this.x+=t,this.y+=e,!0)}getPosition(){return{x:this.x,y:this.y}}setPosition(t){this.x=t.x,this.y=t.y}act(){this.stunned>0&&(this.stunned-=1)}getLight(){return[]}getVision(){return[]}setLevel(t){this.level=t}disable(){}}class H{static moveResults(t,e,i){const s=H.getAllPointsInMoves(e),l=H.getValidRotationsForTemplate(t,e),r=[],h={};h.letters=["W","D","X","A"],h.keypad=["8","6","2","4"];for(let n of l){let o=[];for(let c of s)c=pt(c,n),o.push(c);r.push({symbol:h[i][n],moves:o})}return r}static getLocationInTemplate(t,e){for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++)if(t[i][s]===e)return{x:s,y:i};throw new Error(`No ${e} location found in template`)}static getAllPointsInMoves(t){const e=H.getMaxDigitInTemplate(t),i=H.getLocationInTemplate(t,"@");let s=[];for(let l=1;l<=e;l++)for(let r=0;r<t.length;r++)for(let h=0;h<t[r].length;h++)t[r][h]===l.toString()&&s.push({x:h-i.x,y:r-i.y});return s}static getValidRotationsForTemplate(t,e){var i=H.getLocationInTemplate(e,"@");let s=[];const l=e[0].length>1&&(e[0].length%2==0||e[0].length%2==1&&i.x!=Math.floor(e[0].length/2));for(let o=0;o<4;o++){var r=!1,h=e;for(let c=0;c<(l?2:1);c++){var n=!0;c===1&&(h=H.flipTemplate(e));const u=H.getLocationInTemplate(h,"@");for(let f=0;f<h.length;f++)for(let p=0;p<h[f].length;p++){const g=h[f][p],y=pt({x:p-u.x,y:f-u.y},o),w=t.map.getTile(y.x+t.player.x,y.y+t.player.y),v=t.getBeings().find(R=>R.x===y.x+t.player.x&&R.y===y.y+t.player.y);if(!w){n=!1;break}switch(g){case"@":case"*":break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"0":if(v){n=!1;break}if(w.solid){n=!1;break}else break;case"W":if(w.solid)break;n=!1;break;case"E":if(v)break;n=!1;break}}r=n||r}r&&s.push(o)}return s}static getMaxDigitInTemplate(t){let e=0;for(let i=0;i<t.length;i++)for(let s=0;s<t[i].length;s++)isNaN(parseInt(t[i][s]))||(e=Math.max(e,parseInt(t[i][s])));return e}static flipTemplate(t){const e=[];for(let i=0;i<t.length;i++){const l=t[i].split("").reverse().join("");e.push(l)}return e}}const hi=["1","0","@"],ni=["1W","0W","0W","0W","@W"],oi=["1","0","0","0","0","@","W"],ai=["4","0","0","0","3","2","1","@"],ci=["1","W","@"],ui=["1","0","0","E","0","0","@"];class Kt extends le{constructor(){super(-1,-1,"@",d.YELLOW,d.WHITE);_(this,"health",10);_(this,"depth",-3);_(this,"callbacks",{});_(this,"moves",[]);_(this,"selectedMoveOptions");_(this,"interruptMoves");_(this,"triggerPulse");_(this,"lastMoveName");_(this,"lastPosition");this.moves.push({name:"(1) Jump----------",template:hi,cooldown:0,selected:!1,cooldownOnUse:20}),this.moves.push({name:"(2) Wall Run------",template:ni,cooldown:0,selected:!1,cooldownOnUse:10}),this.moves.push({name:"(3) Jump off wall-",template:oi,cooldown:0,selected:!1,cooldownOnUse:5}),this.moves.push({name:"(4) Running Jump--",template:ai,cooldown:0,selected:!1,cooldownOnUse:30}),this.moves.push({name:"(5) Enemy Jump----",template:ui,cooldown:0,selected:!1,cooldownOnUse:30}),this.moves.push({name:"(6) Burrow--------",template:ci,cooldown:0,selected:!1,cooldownOnUse:100}),this.selectedMoveOptions=[],this.triggerPulse=!1,this.interruptMoves=!1,this.lastPosition={x:-1,y:-1},this.lastMoveName=""}resetLevelCallbacks(){this.callbacks.move=[],this.callbacks.damage=[]}addListener(e,i){let s=this.callbacks[e];s||(s=[]),s.push(i),this.callbacks[e]=s}emit(e){const i=this.callbacks[e];i&&i.forEach(s=>s(this))}resetCooldowns(){this.moves.forEach(e=>{e.cooldown=0})}move(e,i){this.lastPosition={x:this.x,y:this.y};const s=super.move(e,i);return(s||e==0&&i==0)&&this.emit("move"),e==0&&i==0?this.triggerPulse=!0:this.triggerPulse=!1,s}getSelectedMove(){return this.moves.find(e=>e.selected)}selectMove(e){const i=this.getSelectedMove();if(i){console.log("trying to move: "+i.name+"with rotation: "+e),this.interruptMoves=!1;const s=this.selectedMoveOptions.find(l=>l.symbol==e);if(!s)return console.log("Not a valid move option symbol. Resetting move selection."),this.deselectMoves(),!1;i.cooldown=i.cooldownOnUse;for(let l=0;l<s.moves.length&&!this.interruptMoves;l++){let r=s.moves[l];l>0&&(r={x:s.moves[l].x-s.moves[l-1].x,y:s.moves[l].y-s.moves[l-1].y}),this.lastMoveName=i.name,this.move(r.x,r.y),this.updateVision()}return this.deselectMoves(),!0}else{this.deselectMoves();const s=parseInt(e);if(this.moves[s].selected=!0,console.log("move selected: "+this.moves[s].name),this.moves[s].cooldown>0)return console.log("attempted move on CD. Resetting move selection."),this.deselectMoves(),!1;const l=H.moveResults(this.level,this.moves[s].template,this.level.lastKeyStyle);return this.selectedMoveOptions=l,!1}}deselectMoves(){const e=this.moves.find(i=>i.selected);this.selectedMoveOptions=[],e&&(e.selected=!1)}act(){super.act(),this.emit("act"),this.moves.forEach(e=>{e.cooldown>0&&e.cooldown--})}interruptMoveChain(){this.deselectMoves(),this.interruptMoves=!0}takeDamage(e){this.health-=e,console.log("[PLAYER] took damage, health now "+this.health),this.health<=0?this.emit("death"):this.emit("damage"),this.interruptMoveChain()}updateVision(){if(!this.level)return;let e=new Zt.PreciseShadowcasting((i,s)=>this.level.map.pointTransparent(i,s));this.level.map.resetPlayerVisibility(),e.compute(this.x,this.y,10,(i,s,l,r)=>{if(r>0){const h=this.level.map.getTile(i,s);h&&(h.visible=!0,h.discovered=!0)}})}getLight(){const e=[];return this.selectedMoveOptions.forEach(i=>{for(let s of i.moves){const l={p:{x:this.x+s.x,y:this.y+s.y},distance:1,color:d.MOVE_LIGHT_BLUE,being:this};e.push(l)}}),e}}class fi extends se{constructor(e,i,s,l,r){super(e,i,s,l);_(this,"player");this.player=r}draw(e,i,s){const l=this.player.health;for(let r=0;r<this.w;r++)e.draw(i+r+this.x,s+this.y," ",d.DARK_GREY,d.DARK_GREY);e.drawText(0+i+this.x,0+s+this.y,`%c{${d.WHITE}}%b{${d.HEALTH_RED}}H`);for(let r=0;r<l-1;r++)e.draw(1+i+r+this.x,0+s+this.y," ",d.HEALTH_RED,d.HEALTH_RED);e.drawText(this.w-3+i+this.x,0+s+this.y,`%c{${d.WHITE}}%b{${d.DARK_GREY}}L${this.player.depth}`)}}const di={FLOOR:{symbol:".",fg:d.WHITE,bg:d.BLACK,opaque:!1,solid:!1,indestructable:!1},WALL:{symbol:"/",fg:d.LIGHT_GREY,bg:d.WHITE,opaque:!0,solid:!0,indestructable:!1},EXIT:{symbol:"%",fg:d.LIGHT_GREEN,bg:d.BLACK,opaque:!1,solid:!0,indestructable:!0,enabled:!1,power:3},ENTRANCE:{symbol:"%",fg:d.DARK_GREEN,bg:d.BLACK,opaque:!1,solid:!0,indestructable:!0,enabled:!1},BUTTON:{symbol:"○",fg:d.BLACK,bg:d.LIGHT_GREEN,opaque:!0,solid:!0,indestructable:!1},DOOR:{symbol:"-",fg:d.BLACK,bg:d.FAINT_GREEN,opaque:!0,solid:!0,indestructable:!1},EXIT_FORCEFIELD:{symbol:"#",fg:d.LIGHT_GREEN,bg:d.BLACK,opaque:!1,solid:!0,indestructable:!1},BOUNDARY:{symbol:"#",fg:d.LIGHT_GREY,bg:d.WHITE,opaque:!0,solid:!0,indestructable:!0},TALL_JUNK:{symbol:"0",fg:d.LIGHT_GREY,bg:d.BLACK,opaque:!0,solid:!0,indestructable:!1},SHORT_JUNK:{symbol:"o",fg:d.LIGHT_GREY,bg:d.BLACK,opaque:!1,solid:!0,indestructable:!1}};class b{constructor(t,e,i,s="unknown"){_(this,"x");_(this,"y");_(this,"opaque");_(this,"solid");_(this,"symbol");_(this,"fg");_(this,"bg");_(this,"power");_(this,"visible");_(this,"discovered");_(this,"indestructable");_(this,"procGenType");_(this,"procGenDistance");_(this,"enabled");_(this,"type");_(this,"callbacks",{});_(this,"triggerMetadata");this.x=t,this.y=e,this.visible=!1,this.discovered=!1,this.type=i,this.opaque=!1,this.solid=!1,this.symbol=" ",this.fg=d.WHITE,this.bg=d.BLACK,this.indestructable=!1,this.procGenType=s,this.procGenDistance=-1,this.triggerMetadata=null,this.enabled=!0,this.power=0;const l=di[i];Object.assign(this,l),s==="PARTITION"&&i==="WALL"&&(this.symbol="#"),this.type==="FLOOR"?this.bg=d.BLACKS[Math.floor(Math.random()*d.BLACKS.length)]:this.type==="WALL"&&(this.bg=d.WHITES[Math.floor(Math.random()*d.WHITES.length)])}emit(t){const e=this.callbacks[t];e&&e.forEach(i=>i(this))}addListener(t,e){let i=this.callbacks[t];i||(i=[]),i.push(e),this.callbacks[t]=i}}class nt extends b{constructor(e,i){super(e,i,"BUTTON");_(this,"activated");this.activated=!1}interact(e){this.activated||(this.activated=!0,this.symbol="•",this.emit("button"))}}class q extends b{constructor(e,i){super(e,i,"DOOR");_(this,"activated");this.activated=!1}interact(){this.activated=!this.activated,this.opaque=!this.opaque,this.solid=!this.solid,this.activated?(this.bg=d.BLACK,this.fg=d.WHITE,this.symbol="_"):(this.bg=d.WHITE,this.fg=d.BLACK,this.symbol="-")}}class k{constructor(t,e){_(this,"tiles",[]);_(this,"beings",[]);_(this,"latestPlayerPosition");_(this,"disableHunter",!1);this.w=t,this.h=e,this.w=t,this.h=e,this.tiles=[],this.beings=[],this.latestPlayerPosition={x:0,y:0}}fillMapWithWalls(){this.fillMapWithTile("WALL")}fillMapWithTile(t){for(let e=0;e<this.h;e++)for(let i=0;i<this.w;i++)this.tiles.push(new b(i,e,t))}generateTrivialMap(){this.fillMapWithWalls();for(let t=1;t<this.w-1;t++)for(let e=1;e<this.h-1;e++)this.setTile(new b(t,e,"FLOOR"));for(let t=0;t<100;t++){const e=Math.floor(Math.random()*this.w),i=Math.floor(Math.random()*this.h);this.setTile(new b(e,i,"WALL"))}}generateDiggerMap(){this.fillMapWithWalls();const t=new Je.Digger(this.w,this.h),e=(l,r,h)=>{h||this.setTile(new b(l,r,"FLOOR"))};t.create(e.bind(this));const i=this.getFreeTiles(),s=i[Math.floor(Math.random()*i.length)];this.setTile(new b(s.x,s.y,"EXIT"))}getPlayerLocation(){return this.latestPlayerPosition}getIndex(t,e){return t+e*this.w}setTile(t){this.tiles[this.getIndex(t.x,t.y)]=t}getTile(t,e){return this.tiles[this.getIndex(t,e)]}getFreeTiles(){return this.tiles.filter(t=>!t.solid)}getAllTiles(){return this.tiles}getBeings(){return this.beings}getFreePoints(){return this.getFreeTiles().map(t=>({x:t.x,y:t.y}))}resetPlayerVisibility(){for(const t of this.getAllTiles())t.visible=!1}shrinkRect(t){return{x:t.x+1,y:t.y+1,w:t.w-2,h:t.h-2}}shrinkRects(t){const e=[];for(const i of t){const s={x:i.x+1,y:i.y+1,w:i.w-2,h:i.h-2};e.push(s)}return e}getTilesInRect(t){return this.tiles.filter(e=>e.x>=t.x&&e.x<t.x+t.w&&e.y>=t.y&&e.y<t.y+t.h)}setTileMetadata(t,e){const i=this.getTilesInRect(t);for(const s of i)s.procGenType=e}addTilesOnRectBoundaries(t,e="WALL"){for(const i of t){for(let s=i.x;s<i.x+i.w;s++)this.setTile(new b(s,i.y,e,"PARTITION")),this.setTile(new b(s,i.y+i.h-1,e,"PARTITION"));for(let s=i.y;s<i.y+i.h;s++)this.setTile(new b(i.x,s,e,"PARTITION")),this.setTile(new b(i.x+i.w-1,s,e,"PARTITION"))}}pointTransparent(t,e){const i=this.getTile(t,e);return i&&!i.opaque}clear(){this.tiles=[],this.beings=[]}addTemplate(t,e=0,i=!1){const s=this.getFreePoints().filter(h=>this.getTile(h.x,h.y).procGenType!="HALLWAY");let l=!1,r=0;for(;!l&&r<20;){const h=Math.floor(Math.random()*s.length),n=Math.floor(Math.random()*4),o=Math.floor(Math.random()*t.templates.length);this.templateFitsAtPoint(t,s[h],n,o)&&(this.placeTemplateAtPoint(t,s[h],n,o),l=!0),r++}}placeTemplateAtPoint(t,e,i,s){const l=this.getTemplateDimensions(t,s);for(let h=0;h<l.h;h++)for(let n=0;n<l.w;n++){const o=pt({x:n,y:h},i),c=t.templates[s][h][n];var r;switch(c){case" ":r=new b(e.x+o.x,e.y+o.y,"FLOOR");break;case"W":r=new b(e.x+o.x,e.y+o.y,"WALL");break;case"#":r=new b(e.x+o.x,e.y+o.y,"EXIT_FORCEFIELD");break;case"%":r=new b(e.x+o.x,e.y+o.y,"EXIT");break;case"@":r=new b(e.x+o.x,e.y+o.y,"ENTRANCE"),r.procGenType="ENTRANCE";break;case"B":r=new nt(e.x+o.x,e.y+o.y),r.procGenType="BUTTON";break;case"-":r=new q(e.x+o.x,e.y+o.y),r.procGenType="DOOR";break;default:console.error("unrecognized template tile: "+c);break}r&&this.setTile(r)}}templateFitsAtPoint(t,e,i=-1,s){const l=this.getTemplateDimensions(t,s);for(let r=0;r<l.h;r++)for(let h=0;h<l.w;h++){const n=pt({x:h,y:r},i),o=this.getTile(e.x+n.x,e.y+n.y),c=t.templates[s][r][h];if(!o)return!1;switch(c){case"*":continue;case" ":if(o.solid)return!1;break;case"W":if(o.indestructable||o.procGenType=="HALLWAY")return!1;break}if(!o||o.solid)return!1}return!0}getTemplateDimensions(t,e){return{w:t.templates[e][0].length,h:t.templates[e].length}}getAdjacentTiles(t,e,i=!1){const s=[];for(let l=-1;l<=1;l++)for(let r=-1;r<=1;r++){if(l===0&&r===0||i&&Math.abs(l)==1&&Math.abs(r)==1)continue;const h=this.getTile(t+l,e+r);h&&s.push(h)}return s}}_(k,"EXIT",{name:"EXIT",templates:[["WWW","W%W","W#W","W#W","W#W","   "]]}),_(k,"ENTRANCE",{name:"ENTRANCE",templates:[["WWW","W@W","   "],["W W"," @ ","W W"],["WWW","W@W","- -","W-W"]]}),_(k,"BUTTON",{name:"BUTTON",templates:[["W ","WB","W "],[" W"," B"," W"],[" WWW ","  B  "," WWW "],["W W"," B ","W W"]]}),_(k,"WALL",{name:"WALL",templates:[["W","W","W","W","W","W","W"],["W****","W****","W****","WWWWW","W****","W****","W****"],["W  W","W  W","W  W","W  W","*  *"]]});class At extends le{constructor(e,i){super(e,i,"p",d.WHITE,d.LASER_RED);_(this,"facing",0);_(this,"range",12)}getLight(){return this.stunned>0?[]:this.getVision().map(i=>{const s=Math.sqrt(Math.pow(i.x-this.x,2)+Math.pow(i.y-this.y,2));for(var r=K.fromString(d.LASER_RED),h=1;h<s;h++)r=K.multiply(r,K.fromString("#F0F0F0"));return{p:{x:i.x,y:i.y},color:K.toHex(r),distance:s,being:this}})}getVision(){return[]}}class et extends At{constructor(e,i,s="random"){super(e,i);_(this,"behavior","rotate");s=="random"&&(s=Math.random()>.5?"rotate":"flip"),this.behavior=s;const l=[0,Math.PI/2,Math.PI,3*Math.PI/2];this.facing=l[Math.floor(Math.random()*l.length)]}act(){if(super.act(),this.stunned>0)return;const e=Math.round(Math.cos(this.facing)),i=Math.round(Math.sin(this.facing));this.move(e,i)||(this.behavior=="rotate"?this.facing+=Math.PI/2:this.behavior=="flip"&&(this.facing+=Math.PI),this.facing=this.facing%(Math.PI*2))}getVision(){if(!this.level)return[];const e=[];for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){const l={x:this.x+i,y:this.y+s};e.push(l)}for(let i=1;i<=this.range;i++){const s=Math.round(Math.cos(this.facing)*i),l=Math.round(Math.sin(this.facing)*i),r={x:this.x+s,y:this.y+l};if(this.level.map.pointTransparent(r.x,r.y)===!1)break;i!=1&&e.push(r)}return e.filter(i=>this.level.map.pointTransparent(i.x,i.y))}}class Vt extends k{constructor(t,e){super(t,e),this.w=t,this.h=e,this.fillMapWithTile("FLOOR");let i=this.divideSpace({x:2,y:2,w:this.w-4,h:this.h-4});i=this.shrinkRects(i),this.addTilesOnRectBoundaries(i);const s=this.getFreePoints();for(let h=0;h<i.length;h++){const n=i[h],o=this.getPointsWithinRect(n);for(const c of o)for(let u=0;u<s.length;u++)if(s[u].x===c.x&&s[u].y===c.y){s.splice(u,1);const f=this.getTile(c.x,c.y);f.procGenType="ROOM_"+h}for(const c of o)if(Math.random()<.008){this.setTile(new b(c.x,c.y,"TALL_JUNK"));for(let u=-1;u<2;u++)for(let f=-1;f<2;f++)if(Math.random()>.25){const p=this.getTile(c.x+u,c.y+f);p&&p.symbol==="."&&this.setTile(new b(c.x+u,c.y+f,"SHORT_JUNK"))}}}for(const h of s){const n=this.getTile(h.x,h.y);n.procGenType="HALLWAY"}this.addTilesOnRectBoundaries([{x:0,y:0,w:this.w,h:this.h}],"BOUNDARY");const l=this.tiles.filter(h=>h.symbol===" "&&h.indestructable===!1),r=Math.floor(l.length/20);for(let h=0;h<r;h++){const n=Math.floor(Math.random()*l.length),o=l[n];this.setTile(new q(o.x,o.y)),l.splice(n,1)}this.addTemplate(k.BUTTON,-1),this.addTemplate(k.BUTTON,-1),this.addTemplate(k.BUTTON,-1),this.addTemplate(k.EXIT,-1),this.addTemplate(k.ENTRANCE,-1);for(let h=0;h<15;h++)this.addTemplate(k.WALL,-1);for(let h=0;h<10;h++){const n=this.getAllTiles().filter(c=>!(c.procGenType=="HALLWAY"||c.solid));if(!n){console.error("No room tiles to place enemy.");break}const o=n[Math.floor(Math.random()*n.length)];this.beings.push(new et(o.x,o.y)),n.splice(n.indexOf(o),1)}for(let h=0;h<8;h++){const n=this.getAllTiles().filter(c=>c.procGenType=="HALLWAY");if(!n){console.error("No room tiles to place enemy.");break}const o=n[Math.floor(Math.random()*n.length)];this.beings.push(new et(o.x,o.y)),n.splice(n.indexOf(o),1)}}getPointsWithinRect(t){const e=[];for(let i=t.x+1;i<t.x+t.w-1;i++)for(let s=t.y+1;s<t.y+t.h-1;s++)e.push({x:i,y:s});return e}divideSpace(t){const e=[];e.push(t);for(let i=0;i<3;i++){const s=e.pop(),l=Math.random()>.5,r=this.splitRect(s,l);e.push(...r)}return e}splitRect(t,e){const i=[];if(e){const s=Math.floor(t.y+t.h/2),l={x:t.x,y:t.y,w:t.w,h:s-t.y},r={x:t.x,y:s,w:t.w,h:t.y+t.h-s};i.push(l,r)}else{const s=Math.floor(t.x+t.w/2),l={x:t.x,y:t.y,w:s-t.x,h:t.h},r={x:s,y:t.y,w:t.x+t.w-s,h:t.h};i.push(l,r)}return i}}class ot extends At{constructor(e,i,s){super(e,i);_(this,"map");_(this,"hasMovedThisCycle");_(this,"nextMove");_(this,"doorCountdown");_(this,"pointsInVision");_(this,"juggernaut",!1);_(this,"listeners",[]);this.map=s,this.hasMovedThisCycle=!1,this.nextMove={x:0,y:0},this.symbol="H",this.doorCountdown=-1,this.pointsInVision=[]}resetMoveListeners(){this.listeners=[]}addMoveListener(e){this.listeners.push(e)}enableJuggernaut(){this.juggernaut=!0}disableJuggernaut(){this.juggernaut=!1}queueNextMove(){const e=this.map.getPlayerLocation();console.log(`queueing next move with hunter at : ${this.x},${this.y} and player at ${e.x},${e.y}`),new Z.AStar(e.x,e.y,(s,l)=>{const r=this.map.getTile(s,l);return r?this.juggernaut?r.type!=="BOUNDARY":r.type=="DOOR"||r.type=="ENTRANCE"?!0:!r.solid:!1}).compute(this.x,this.y,(s,l)=>{const r=l-this.y,h=s-this.x;!(s==this.x&&l==this.y)&&Math.abs(r)<=1&&Math.abs(h)<=1&&(this.nextMove={x:s-this.x,y:l-this.y},this.hasMovedThisCycle=!0)})}act(){if(super.act(),!(this.stunned>0))if(console.log("hunter got act()"),this.nextMove){const e=this.map.getTile(this.nextMove.x+this.x,this.nextMove.y+this.y);if(e&&e.type=="DOOR"){if(this.doorCountdown==-1){this.doorCountdown=2;return}const i=e;if(i.solid&&this.doorCountdown==0){i.interact(),this.doorCountdown=-1;return}else this.doorCountdown--}if(this.juggernaut){const i=this.map.getTile(this.x+this.nextMove.x,this.y+this.nextMove.y);if(i.type==="WALL"||i.type==="DOOR"){const s=new b(i.x,i.y,"FLOOR");s.symbol="$",this.map.setTile(s)}}this.move(this.nextMove.x,this.nextMove.y),this.listeners.forEach(i=>{i(this)}),this.updateVision(),this.queueNextMove()}else this.queueNextMove()}updateVision(){if(!this.map)return;let e=new Zt.PreciseShadowcasting((i,s)=>this.level.map.pointTransparent(i,s));this.pointsInVision=[],e.compute(this.x,this.y,2,(i,s,l,r)=>{r>0&&this.pointsInVision.push({x:i,y:s})})}getVision(){return this.level?this.pointsInVision:[]}disable(){this.stunned=1e5}enable(){this.stunned=0}active(){return this.stunned==0}}class re extends At{constructor(t,e,i=0){super(t,e),this.symbol="s",this.facing=i,this.range=20,this.bg=d.WHITE}act(){super.act(),this.stunned>0}getVision(){if(!this.level)return[];const t=[];for(let e=0;e<Math.PI*2;e+=Math.PI/2)for(let i=1;i<=this.range;i++){const s=Math.round(Math.cos(e)*i),l=Math.round(Math.sin(e)*i),r={x:this.x+s,y:this.y+l};if(this.level.map.pointTransparent(r.x,r.y)===!1)break;t.push(r)}return t.push({x:this.x,y:this.y}),t.filter(e=>this.level.map.pointTransparent(e.x,e.y))}}class pi extends k{constructor(e,i,s){super(e,i);_(this,"totalRooms");this.w=e,this.h=i,this.totalRooms=0;var l=!1;do this.generateLevel(s),l=this.validDesign();while(!l)}generateLevel(e){this.tiles=[],this.beings=[],this.fillMapWithTile("FLOOR");let i=0;this.totalRooms=0;const s=[1,1,2,2,2,3,3,3,3,3,3,3,4,4],l=s[Math.floor(Math.random()*s.length)];let r=[];for(var h=0;r.length<l;){let T=Math.floor(Math.random()*(this.w-10))+5,m=!0;for(const E of r)Math.abs(T-E)<5&&(m=!1);if(m&&r.push(T),h++,h>=30){console.log("too many attempts to find valid partition stopping");break}}r.sort((T,m)=>T-m),r.push(this.w);var n=0;for(let T of r){var o=[0,0,1,1,1,1,1,1,2,2,2,2],c=o[Math.floor(Math.random()*o.length)];let m=[],E=0,L=!1;const A=0;let C={x:i,y:0,w:T-i,h:this.h};switch(c){case 0:C={x:i,y:0,w:T-i,h:this.h},this.addTilesOnRectBoundaries([C],"WALL"),this.setTileMetadata(this.shrinkRect(C),"ROOM_"+n),n++;break;case 1:m.push(Math.floor(Math.random()*(this.h-15))+5),E=0,L=!1;for(const D of m)C={x:i,y:E,w:T-i,h:D},L||Math.random()>A?this.addTilesOnRectBoundaries([C],"WALL"):L=!0,E+=D-1,this.setTileMetadata(this.shrinkRect(C),"ROOM_"+n),n++;C={x:i,y:E,w:T-i,h:this.h-E},(L||Math.random()>A)&&this.addTilesOnRectBoundaries([C],"WALL"),this.setTileMetadata(this.shrinkRect(C),"ROOM_"+n),n++;break;case 2:const lt=Math.floor(Math.random()*(this.h-10-5))+5;m.push(lt),m.push(Math.floor(Math.random()*(this.h-10-lt)+5)),console.log(m),E=0,L=!1;for(const D of m)L||Math.random()>A?(C={x:i,y:E,w:T-i,h:D},this.addTilesOnRectBoundaries([C],"WALL"),E+=D-1):L=!0,this.setTileMetadata(this.shrinkRect(C),"ROOM_"+n),n++;C={x:i,y:E,w:T-i,h:this.h-E},(L||Math.random()>.33)&&this.addTilesOnRectBoundaries([C],"WALL"),this.setTileMetadata(this.shrinkRect(C),"ROOM_"+n),n++;break}i=T-1}this.addTilesOnRectBoundaries([{x:0,y:0,w:this.w,h:this.h}],"BOUNDARY"),this.totalRooms=n;for(let T=0;T<this.totalRooms;T++){let m=this.getRectForRoomId(T),E;m.w>=9&&m.h>=9?E=new gi(m):Math.random()>.5?E=new _i(m):E=new mi(m),E.fillRoom();const L=E.getTiles();for(let A of L)this.setTile(A)}var u=[];let f=this.tiles.filter(T=>T.type==="WALL"&&T.procGenType!=="PARTITION");for(let T=0;T<3;T++){const m=Math.floor(Math.random()*f.length),E=f[m];this.setTile(new nt(E.x,E.y)),f.splice(m,1),u.push({x:E.x,y:E.y})}const p=this.tiles.filter(T=>T.x===0&&T.type==="BOUNDARY");for(var g={x:-1,y:-1};p.length>0;){const T=Math.floor(Math.random()*p.length),m=p[T];if(m){if(m.y<2||m.y>this.h-3)continue;let E=0;for(let L=-1;L<1;L++){const A=this.getTile(m.x+2,m.y+L);A&&A.type==="FLOOR"&&E++}if(E>=1){this.setTile(new b(m.x+1,m.y-1,"BOUNDARY")),this.setTile(new b(m.x+1,m.y,"ENTRANCE")),this.setTile(new b(m.x+1,m.y+1,"BOUNDARY")),u.push({x:m.x+1,y:m.y}),g={x:m.x+1,y:m.y};break}}p.splice(T,1)}const y=this.tiles.filter(T=>T.x===this.w-1&&T.type==="BOUNDARY");for(;y.length>0;){const T=Math.floor(Math.random()*y.length),m=y[T];if(!(m.y<2||m.y>this.h-3)){if(m){let E=!0;for(let L=0;L<2;L++)for(let A=-1;A<1;A++){const C=this.getTile(m.x-1-L,m.y+A);C&&(C.type==="BOUNDARY"||C.type==="BUTTON"||C.procGenType==="PARTITION")&&(E=!1)}if(E){this.setTile(new b(m.x-1,m.y-1,"BOUNDARY","EXIT_TEMPLATE")),this.setTile(new b(m.x-1,m.y,"EXIT","EXIT_TEMPLATE")),this.setTile(new b(m.x-1,m.y+1,"BOUNDARY","EXIT_TEMPLATE")),this.setTile(new b(m.x-2,m.y-1,"FLOOR","EXIT_TEMPLATE")),this.setTile(new b(m.x-2,m.y,"FLOOR","EXIT_TEMPLATE")),this.setTile(new b(m.x-2,m.y+1,"FLOOR","EXIT_TEMPLATE")),u.push({x:m.x-1,y:m.y});break}}y.splice(T,1)}}const w=this.tiles.filter(T=>T.procGenType==="PARTITION"),v=[];for(let T=0;T<w.length;T++){const m=w[T];if(m.x==0||m.x==this.w-1)continue;const E=this.getAdjacentTiles(m.x,m.y,!0);let L=0,A=!0;for(const C of E)C&&(C.procGenType==="PARTITION"&&L++,C.type!=="PARTITION"&&(A=!1));L>2&&!A&&v.push({x:m.x,y:m.y})}const R=[];for(const T of v){const m=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];for(const E of m){var I=["BLANK","DOORS","BLANK_SECTION"],S=I[Math.floor(Math.random()*I.length)],X=.1,Q=!1,G=[],st=Math.floor(Math.random()*5),j=0,Y=2;let L=T.x+E.x,A=T.y+E.y;const C=this.getTile(L,A);if(!(C&&(C.type==="FLOOR"||C.type==="BOUNDARY")))for(;;){const lt=this.getTile(L,A);if(!lt||lt.type==="BOUNDARY"||R.some(D=>D.x===L&&D.y===A)){if(!Q&&S==="DOORS"&&G.length>0){const D=Math.floor(Math.random()*G.length),It=G[D];this.setTile(new q(It.x,It.y))}break}R.push({x:L,y:A}),S==="BLANK"?this.setTile(new b(L,A,"FLOOR")):S==="DOORS"?(G.push({x:L,y:A}),Math.random()<X&&(this.setTile(new q(L,A)),Q=!0,X=.05)):S==="BLANK_SECTION"&&(j>=Y&&j<=Y+st&&this.setTile(new b(L,A,"FLOOR")),j++),L+=E.x,A+=E.y}}}const W=this.getAllTiles().filter(T=>!(T.procGenType=="HALLWAY"||T.solid));console.log("DIFFICULTY: "+e);for(var V=0;V<10+e*5;V++){const T=W[Math.floor(Math.random()*W.length)];Math.abs(T.x-g.x)+Math.abs(T.y-g.y)<5||(this.beings.push(new et(T.x,T.y)),W.splice(W.indexOf(T),1))}f=this.getAllTiles().filter(T=>T.solid&&T.type==="WALL");for(var V=0;V<(e>0?10:0);V++){const m=f[Math.floor(Math.random()*f.length)];Math.abs(m.x-g.x)+Math.abs(m.y-g.y)<3||(this.beings.push(new re(m.x,m.y)),f.splice(f.indexOf(m),1))}}getRectForRoomId(e){let i={x:1/0,y:1/0,w:0,h:0};for(let s of this.tiles)s.procGenType==="ROOM_"+e&&(i.x=Math.min(i.x,s.x),i.y=Math.min(i.y,s.y),i.w=Math.max(i.w,s.x-i.x+1),i.h=Math.max(i.h,s.y-i.y+1));return i}validDesign(){const e=this.tiles.find(h=>h.type==="ENTRANCE");if(!e)return!1;const i=this.tiles.filter(h=>h.type==="BUTTON"||h.type==="EXIT").map(h=>({x:h.x,y:h.y})),s=new Z.AStar(e.x,e.y,(h,n)=>{const o=this.getTile(h,n);return o?o.type=="DOOR"||o.type=="ENTRANCE"||o.type=="EXIT"||o.type=="BUTTON"?!0:!o.solid:!1});var l=!0;for(const h of i){var r=!1;s.compute(h.x,h.y,(n,o)=>{n===e.x&&o===e.y&&(r=!0)}),r&&console.log("synchronously valid design: "+JSON.stringify(h)+" "+r),r||(l=!1)}return l}}class Ot{constructor(t){_(this,"tiles");_(this,"rect");this.rect=t,this.tiles=[];for(let e=0;e<t.h;e++)for(let i=0;i<t.w;i++)this.tiles.push(new b(i,e,"FLOOR"))}getPointsOnRectBoundaries(t){let e=[];for(let i=t.x;i<t.x+t.w;i++)e.push({x:i,y:t.y}),e.push({x:i,y:t.y+t.h-1});for(let i=t.y;i<t.y+t.h;i++)e.push({x:t.x,y:i}),e.push({x:t.x+t.w-1,y:i});return e}getTile(t,e){return this.tiles[e*this.rect.w+t]}setTile(t,e,i){!i||e*this.rect.w+t>=this.tiles.length||t>=this.rect.w||e>=this.rect.h||t<0||e<0||(this.tiles[e*this.rect.w+t]=i)}translateTiles(){for(let t of this.tiles)t.x=t.x+this.rect.x,t.y=t.y+this.rect.y}getTiles(){return this.tiles}fillRoom(){}}class _i extends Ot{fillRoom(){var t=new ei.Simplex;for(let e of this.tiles)t.get(e.x/5,e.y/5)*255>100&&this.setTile(e.x,e.y,new b(e.x,e.y,"WALL"));this.translateTiles()}}class gi extends Ot{fillRoom(){var t=this.shrinkRect(this.shrinkRect(this.rect));for(let e=0;e<10&&!(t.w<6&&t.h<6);e++){for(const i of this.getPointsOnRectBoundaries(t)){const s={x:i.x-this.rect.x,y:i.y-this.rect.y};s.x>t.w/5+4&&s.x<t.w-(t.w/5+2)||s.y>t.h/5+4&&s.y<t.h-(t.w/5+2)||this.setTile(s.x,s.y,new b(s.x,s.y,"WALL"))}t=this.shrinkRect(this.shrinkRect(this.shrinkRect(t)))}this.translateTiles()}shrinkRect(t){return{x:t.x+1,y:t.y+1,w:t.w-2,h:t.h-2}}}class mi extends Ot{fillRoom(){var t=this.rect.w,e=this.rect.h;const i=Math.random()>.5?"H":"V",s=i==="V"?t:e,l=i==="V"?e:t,r=Math.floor((s-1)/2),h=(s-1)%2===1;var n=1;for(let c=0;c<r;c++){const u=l>4;var o=Math.floor(Math.random()*(l-4))+2;for(let f=1;f<l-1;f++)u&&f===o||(i==="V"?this.setTile(n,f,new b(n,f,"WALL")):this.setTile(f,n,new b(f,n,"WALL")));n+=2,Math.random()>.95&&(n+=2,c++)}if(h){const c=Math.floor(Math.random()*2+2);for(let u=1;u<l-1;u+=c)i==="V"?this.setTile(s-1,u,new b(s-1,u,"WALL")):this.setTile(u,s-1,new b(u,s-1,"WALL"))}this.translateTiles()}}class yt extends k{constructor(t){super(0,0),this.disableHunter=!0,this.loadMap(t)}loadMap(t){const e=yi[t];e||console.error("No map found for name: "+t),this.w=e.map[0].length,this.h=e.map.length,console.log("setting w and h: "+this.w+" "+this.h);for(let i=0;i<this.h;i++)for(let s=0;s<this.w;s++){const l=e.map[i][s];switch(l){case"#":this.setTile(new b(s,i,"BOUNDARY"));break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"A":case"B":case"A":case"B":case"C":case"E":case"F":case"G":case"I":case"J":case"K":const r=new b(s,i,"FLOOR");r.triggerMetadata={trigger:l,text:e.text[l]},this.setTile(r);break;case"x":const h=new b(s,i,"FLOOR");h.symbol="x",h.fg=d.LIGHT_GOLD,this.setTile(h);break;case" ":case".":this.setTile(new b(s,i,"FLOOR"));break;case"@":this.setTile(new b(s,i,"ENTRANCE"));break;case"s":this.setTile(new b(s,i,"FLOOR"));const n=new re(s,i,0);this.beings.push(n);break;case"p":this.setTile(new b(s,i,"FLOOR"));const o=new et(s,i,"flip");o.facing=Math.PI/2,this.beings.push(o);break;case"-":this.setTile(new q(s,i));break;case"b":const c=new nt(s,i);this.setTile(c);break;case"H":this.setTile(new b(s,i,"FLOOR"));const u=new ot(s,i,this);u.disable(),this.beings.push(u);break;case"D":const f=new b(s,i,"FLOOR");f.symbol="*",f.fg=d.GOLD,f.bg=d.DARK_GREY,f.triggerMetadata={trigger:l,text:e.text[l]},this.setTile(f);break;case"%":this.setTile(new b(s,i,"EXIT"));break;default:console.error("unrecognized tile character: "+l);break}}}}const yi={tutorial1:{map:["#################################","#...3...-2......-4.x...-5x.....##","#...#####2......#4.x...###...#-##","#-#######.......####s#####sss#6##","#11...0@#....p..######7777....x##","#11...00#.......######.##.......#","######################-##########","#..H.....#..........##8##......##","#........#..........##x##......##","#........########################","#........##....#######.##......##","#.......A#######p#####.##......##","#.......A-.........x9-.##......##","#.......A#######.########......##","#######.##.....#####b############","#....##.#...#..............######","#....##.#...###########....######","#....##B-...###########....C..%##","#....####...#..............######","#.....###........#b#.....#b#...##","#################################"],text:{0:`Welcome, %c{${d.MOVE_LIGHT_BLUE}}runner%c{}. I see you can move, at least.`,1:`Proceed through the door. Press %c{${d.MOVE_LIGHT_BLUE}}(NUM 5/s)%c{} to wait next to the door to open it.`,2:`Patrol bot ahead. If you move into its vision, it'll shoot you. Use %c{${d.MOVE_LIGHT_BLUE}}(NUM 5/s)%c{#ffffff} to wait for an opportune moment to run past.`,3:"Close that door behind you! What kind of runner leaves open doors behind them?",4:`This is where your implants come in handy. Walk up to the sentry vision and jump over it with %c{${d.MOVE_LIGHT_BLUE}}(1)%c{}, then select the direction.`,5:`One sentry is nothing. This is more common in the field. Use %c{${d.MOVE_LIGHT_BLUE}}(2) wall run%c{} to get past them.`,6:`You won't always have time to wait for your moves to cooldown; use %c{${d.MOVE_LIGHT_BLUE}}(3) Jump off wall%c{} on this wall to get past these sentries.`,7:"Nominal performance. Let's try your last two moves.",8:`Dead end? Not for you. Use %c{${d.MOVE_LIGHT_BLUE}}(6) burrow%c{} to dig through the wall south.`,9:`Stand %c{${d.MOVE_LIGHT_BLUE}}3 spaces from the enemy%c{}. Then use %c{${d.MOVE_LIGHT_BLUE}}(5) enemy jump%c{} to    jump over them. Be patient.`,A:`Now, meet your antagonist. The %c{${d.LIGHT_LASER_RED}}HUNTER%c{}. It's relentless, and  can sense you from any distance.`,B:`%c{${d.LIGHT_LASER_RED}}You can't fight it%c{}. Hit the %c{${d.LIGHT_GREEN}}buttons%c{} (wait next to them) and then run to the %c{${d.LIGHT_GREEN}}exit.`,C:`Acceptable job, %c{${d.MOVE_LIGHT_BLUE}}runner%c{}. Don't embarrass me on the job.`}},vault:{map:["###################","##................#","##000...###..2222##","#@000....D...2222%#","##000...###..2222##","##................#","###################"],text:{0:`There it is! %c{${d.RAINBOW_0}}a%c{${d.RAINBOW_1}}m%c{${d.RAINBOW_2}}u%c{${d.RAINBOW_3}}l%c{${d.RAINBOW_4}}e%c{${d.RAINBOW_5}}t%c{}.dat! Grab it!`,D:`ALERT: %c{${d.LASER_RED}}RUNNER DETECTED. HUNTER ACTIVATED`,2:`Time to %c{${d.MOVE_LIGHT_BLUE}}run%c{#fff}. Three floors of security between you and the exit. Good luck, %c{${d.MOVE_LIGHT_BLUE}}runner%c{}. See  you on the other side.`}}};class ft{constructor(t,e,i,s=0,l=null){_(this,"map");_(this,"beings");_(this,"scheduler",new We.Simple);_(this,"w",80);_(this,"h",23);_(this,"x",0);_(this,"y",0);_(this,"player",null);_(this,"firstTurnRender",!1);_(this,"turnCounter");_(this,"hunter",null);_(this,"overlays",null);_(this,"lastKeyStyle","");_(this,"suppressObjectives",!1);_(this,"type");switch(this.beings=[],this.w=e,this.h=i,this.overlays=l,this.turnCounter=0,this.type=t,t){case O.CAVE:this.map=new k(this.w,this.h),this.map.generateDiggerMap();for(let h=0;h<4;h++){const n=this.getEmptyPoints();if(!n){console.error("No free cells to place enemy.");break}const o=n[Math.floor(Math.random()*n.length)];this.createEnemy(o),n.splice(n.indexOf(o),1)}for(let h=0;h<2;h++){const n=this.getEmptyPoints();if(!n){console.error("No free cells to place button.");break}const o=n[Math.floor(Math.random()*n.length)];this.map.setTile(new nt(o.x,o.y))}for(let h=0;h<4;h++){const n=this.getEmptyPoints();if(!n){console.error("No free cells to place door.");break}const o=n[Math.floor(Math.random()*n.length)];this.map.setTile(new q(o.x,o.y))}break;case O.DEBUG:this.map=new Vt(this.w,this.h),this.map.getBeings().forEach(h=>{this.addBeing(h)});break;case O.EDGE_ROOM:this.map=new pi(this.w,this.h,s),this.map.getBeings().forEach(h=>{this.addBeing(h)});break;case O.BSP:this.map=new Vt(this.w,this.h),this.map.getBeings().forEach(h=>{this.addBeing(h)});break;case O.RANDOM:this.map=new k(this.w,this.h),this.map.generateTrivialMap();for(let h=0;h<8;h++){const n=this.map.getFreePoints();if(!n){console.error("No free cells to place enemy.");break}const o=n[Math.floor(Math.random()*n.length)],c=new et(o.x,o.y,"random");this.addBeing(c)}break;case O.TUTORIAL:this.map=new yt("tutorial1"),this.map.getBeings().forEach(h=>{this.addBeing(h)}),this.hunter=this.map.getBeings().find(h=>h instanceof ot),this.suppressObjectives=!0;break;case O.INTRO:this.map=new yt("intro1"),this.map.getBeings().forEach(h=>{this.addBeing(h)}),this.suppressObjectives=!1;break;case O.VAULT:this.map=new yt("vault"),this.map.getBeings().forEach(h=>{this.addBeing(h)}),this.suppressObjectives=!1;const r=this.map.getAllTiles().find(h=>h.type==="EXIT");r&&(r.power=0,r.enabled=!0,r.solid=!1);break}this.map.getAllTiles().forEach(r=>{r instanceof nt&&r.addListener("button",h=>{var u;const n=this.map.getAllTiles().find(f=>f.type==="EXIT");if(n&&(n.power--,n.power==0)){n.enabled=!0,n.solid=!1,(u=this.overlays)==null||u.addLayer("path-to-exit");var o=0;if(n){const f=new Z.AStar(n.x,n.y,(p,g)=>!0);if(f){var c=!1;f.compute(this.player.x,this.player.y,(p,g)=>{o++,setTimeout(()=>{if(!this.overlays)return;if(this.overlays.setValueOnLayer("path-to-exit",p,g,d.LIGHT_GREEN+"80"),this.overlays.draw(),Math.floor(Math.sqrt(Math.pow(Math.abs(n.x-p),2)+Math.pow(Math.abs(n.y-g),2)))<=1&&!c){for(let w=-1;w<=1;w++)for(let v=-1;v<=1;v++){const R=this.map.getTile(n.x+w,n.y+v);R&&(R.discovered=!0,R.visible=!0)}c=!0}},o*10+100)}),setTimeout(()=>{var p;(p=this.overlays)==null||p.startLayerFade("path-to-exit",1e3,10,.9)},1e3)}}}})})}addBeing(t){t.setLevel(this),this.beings.push(t),this.scheduler.add(t,!0)}removeBeing(t){const e=this.beings.indexOf(t);e!==-1&&this.beings.splice(e,1)}getBeings(){return this.beings}showObjectivePathOverlays(){if(!this.overlays)return;const t=this.map.getAllTiles().filter(s=>s.type==="BUTTON");this.overlays.addLayer("button-pathing");for(var e of t){const s=new Z.AStar(e.x,e.y,(l,r)=>!0);var i=0;s.compute(this.player.x,this.player.y,(l,r)=>{i++,setTimeout(()=>{this.overlays&&(this.overlays.setValueOnLayer("button-pathing",l,r,d.LIGHT_GREEN+"80"),this.overlays.draw())},i*10+100)}),setTimeout(()=>{this.overlays&&this.overlays.startLayerFade("button-pathing",1e3,10,.9)},1e3),e.discovered=!0,e.visible=!0}}draw(t,e,i,s){var h;const l=this.map.getAllTiles(),r=this.mergeLightMaps();for(const n of l)this.drawTile(n,t,e,i,r);if(this.turnCounter==0&&!this.firstTurnRender&&(this.suppressObjectives||this.showObjectivePathOverlays(),this.firstTurnRender=!0,this.draw(t,e,i,s)),this.player&&this.player.triggerPulse&&((h=this.hunter)!=null&&h.active())&&this.hunter){const n=Math.floor(Math.sqrt(Math.pow(Math.abs(this.hunter.x-this.player.x),2)+Math.pow(Math.abs(this.hunter.y-this.player.y),2)));if(console.log("distance: "+n),!this.overlays)return;for(let o=Math.max(n-3,1);o<=n;o++){let c=[];for(let u=0;u<=Math.PI*2;u+=Math.PI/(4*n))c.push({x:Math.floor(o*Math.cos(u)),y:Math.floor(o*Math.sin(u))});console.log("pulsing for r="+o+" points: "+c.length),c=c.filter((u,f)=>c.indexOf(u)===f),this.overlays.addLayer("hunter-pulse"),setTimeout(()=>{for(let u of c)this.overlays.setValueOnLayer("hunter-pulse",u.x+this.player.x,u.y+this.player.y,d.LASER_RED+Math.floor(.9*255).toString(16));this.overlays.draw()},(3-(n-o))*50)}setTimeout(()=>{this.overlays&&this.overlays.startLayerFade("hunter-pulse",5e3,40,.9)},60)}}drawTile(t,e,i,s,l){var o;if(!t.discovered)return;let r=t.fg,h=t.bg;t.visible?(`${t.x},${t.y}`in l?h=l[`${t.x},${t.y}`].color:h=t.bg,(t.type==="BOUNDARY"||t.type==="WALL")&&(r=d.MID_GREY)):(h=d.BLACK,r=d.INVISIBLE_TILE),t.opaque&&(h=t.bg),!t.visible&&(t.type==="BOUNDARY"||t.type==="WALL")&&(h=d.DARK_GREY,r=d.MID_GREY),e.draw(t.x+this.x,t.y+this.y,t.symbol,r,h);for(let c of this.beings){const u=this.map.getTile(c.x,c.y);if(u||console.error("being at invalid location",c.x,c.y,c),u&&u.visible){let f=d.BLACK;const p=`${c.x},${c.y}`;p in l&&(f=l[p].color),c.draw(e,this.x,this.y,f)}}const n=((o=this.player)==null?void 0:o.selectedMoveOptions)??[];for(const c of n){const u=c.moves[c.moves.length-1];e.draw(u.x+this.x+this.player.x,u.y+this.y+this.player.y,c.symbol,d.WHITE,d.MOVE_BLUE)}}pointPassable(t,e){const i=this.map.getTile(t,e);return i&&!i.solid&&!this.isBeingOccupyingPoint(t,e)}isBeingOccupyingPoint(t,e){for(const i of this.beings){const s=i.getPosition();if(s.x===t&&s.y===e)return!0}return!1}getEmptyPoints(){const t=this.map.getFreePoints(),e=this.getBeingOccupiedTiles();return t.filter(s=>!e.some(l=>l.x===s.x&&l.y===s.y))}getBeingOccupiedTiles(){const t=[];for(const e of this.beings)t.push(e.getPosition());return t}mergeLightMaps(){let t=[];for(let r of this.beings)t.push(...r.getLight());const e={};for(const r of t){var i=e[`${r.p.x},${r.p.y}`];i?i.push(r):i=[r],e[`${r.p.x},${r.p.y}`]=i}const s={};for(let r in e){let h=d.BLACK;var l=e[r][0].being;if(r in e){const n=[-1,-1,-1];let o=n;const c=e[r];for(let u of c)o===n?o=K.fromString(u.color):o=K.add(o,K.fromString(u.color));h=K.toHex(o).toString()}s[r]={p:{x:parseInt(r.split(",")[0]),y:parseInt(r.split(",")[1])},distance:10,color:h,being:l}}return s}getEnemyVisiblePoints(){return Object.values(this.mergeLightMaps()).map(e=>`${e.p.x},${e.p.y}`)}createEnemy(t){this.addBeing(new et(t.x,t.y))}setPlayer(t){this.player=t,this.player.resetLevelCallbacks(),this.player.setLevel(this);const e=this.map.getAllTiles().filter(i=>i.type==="ENTRANCE");if(e.length>0){const i=e[Math.floor(Math.random()*e.length)];t.setPosition({x:i.x,y:i.y})}console.log("placed player: "+t.x+","+t.y),this.type===O.TUTORIAL?this.player.depth=-5:this.type===O.VAULT&&(this.player.depth=-4),this.scheduler.add(t,!0),this.beings.push(t),console.log("beings: "+this.beings),this.turnCounter=0,this.player.addListener("move",()=>{if(this.map.latestPlayerPosition={x:this.player.x,y:this.player.y},this.player.lastMoveName==="(6) Burrow--------"){this.player.lastMoveName="";const i={x:this.player.x-this.player.lastPosition.x,y:this.player.y-this.player.lastPosition.y};console.log("BURROWED: "+i.x+","+i.y);const s={x:this.player.x-i.x/2,y:this.player.y-i.y/2};console.log("POSITION: ",s.x,s.y),this.map.setTile(new q(s.x,s.y)),console.log(this.map.getTile(s.x,s.y))}if(this.turnCounter++,this.turnCounter==20&&!this.map.disableHunter){console.log("-----------HUNTER ENTERING----------");const i=this.map.getAllTiles().filter(s=>s.type==="ENTRANCE");if(i){const s=new ot(i[0].x,i[0].y,this.map);s.queueNextMove(),this.hunter=s,this.addBeing(s)}}}),this.player.addListener("damage",i=>{var s,l,r;console.log("add damage overlay"),(s=this.overlays)==null||s.addLayer("player-damage",d.LASER_RED+"80"),(l=this.overlays)==null||l.draw(),(r=this.overlays)==null||r.startLayerFade("player-damage",1e3,10,.9)}),this.player.addListener("move",i=>{var r,h;const s=this.map.getTile(i.x,i.y);if(s&&s.symbol==="*"&&(this.map.disableHunter=!1,this.turnCounter=19,s.symbol="."),console.log("checking move damage safety"),this.getEnemyVisiblePoints().includes(`${i.x},${i.y}`)){let n=this.mergeLightMaps()[`${i.x},${i.y}`].being;if(n){(r=this.overlays)==null||r.addLayer("shot-line");const o=new Z.AStar(i.x,i.y,(c,u)=>!0);var l=0;o.compute(n.x,n.y,(c,u)=>{l++,setTimeout(()=>{this.overlays&&(this.overlays.setValueOnLayer("shot-line",c,u,d.WHITE+"FF"),this.overlays.draw())},l*10+100)}),setTimeout(()=>{this.overlays&&this.overlays.startLayerFade("shot-line",1e3,10,.9)},140),n.stun(4)}i.takeDamage(1),i.interruptMoveChain()}else if(console.log("no enemy seeing your movement"),Math.sqrt(Math.pow(Math.abs(i.x-i.lastPosition.x),2)+Math.pow(Math.abs(i.y-i.lastPosition.y),2))>=2){(h=this.overlays)==null||h.addLayer("player-move");var l=0;new Z.AStar(i.x,i.y,(u,f)=>!0).compute(i.lastPosition.x,i.lastPosition.y,(u,f)=>{l++,setTimeout(()=>{this.overlays&&(this.overlays.setValueOnLayer("player-move",u,f,d.MOVE_LIGHT_BLUE+"80"),this.overlays.draw())},l*20)}),setTimeout(()=>{this.overlays&&this.overlays.startLayerFade("player-move",1e3,10,.9)},140)}})}disable(){var t;console.log("CLEARING SCHEDULER"),this.scheduler.clear(),(t=this.hunter)==null||t.disable(),this.hunter=null,this.beings=[],this.map.clear(),this.beings=[]}activateHunter(){var t;(t=this.hunter)==null||t.enable()}}class Ti extends it{constructor(e,i,s){super(e,i);_(this,"player");this.player=s,this.setPlayer(s)}draw(e,i=0,s=0){for(let r=0;r<this.height;r++)for(let h=0;h<this.width;h++)e.draw(h+i+this.x,r+s+this.y,"-",d.DARK_GREY,d.DARK_GREY);e.drawText(i+this.x,s+this.y,`%c{${d.BLACK}}%b{${d.LIGHT_GREY}}MOVES%c{${d.LIGHT_GREY}}%b{${d.LIGHT_GREY}}${"-".repeat(this.width-5)}`);let l=0;for(let r of this.player.moves){const h=r.name,n=1,o=l+1;let c=d.DARK_GREY,u=d.WHITE,f=d.WHITE,p=d.DARK_GREY;r.cooldown>0?f=d.MID_GREY:f=d.WHITE;for(let g=0;g<h.length;g++){const y=h[g];g<r.cooldown?(u=d.WHITE,c=d.RED):(u=f,c=p,r==this.player.getSelectedMove()&&(c=d.MOVE_BLUE,u=d.WHITE)),y=="-"&&(u=c),e.draw(n+i+this.x+g,o+s+this.y,y,u,c)}l++}super.draw(e,i,s)}setPlayer(e){this.player=e}}class he{constructor(t,e,i,s){_(this,"x");_(this,"y");_(this,"height");_(this,"width");_(this,"layers");_(this,"callbacks",{});_(this,"bufferCanvas");_(this,"visibleCanvas");_(this,"tileY");_(this,"tileX");this.x=t,this.y=e,this.width=i,this.height=s,this.layers={};const l=document.getElementById("game");this.bufferCanvas=document.createElement("canvas"),this.bufferCanvas.id="overlay-buffer",this.bufferCanvas.width=l.width,this.bufferCanvas.height=l.height,this.tileX=l.width/F,this.tileY=l.height/U,this.visibleCanvas=document.createElement("canvas"),this.visibleCanvas.id="overlay-visible",this.visibleCanvas.width=l.width,this.visibleCanvas.height=l.height,this.visibleCanvas.style.backgroundColor="rgba(0,0,0,0)",this.visibleCanvas.style.position="absolute",this.visibleCanvas.style.top="0px",this.visibleCanvas.style.left="0px",document.body.appendChild(this.visibleCanvas)}addLayer(t,e="#00000000"){if(this.layers[t])return;const i=[];for(let s=0;s<this.width*this.height;s++)i.push(e);this.layers[t]=i}setValueOnLayer(t,e,i,s){const l=this.layers[t];e>this.width||i>this.height||e<0||i<0||l&&this.setValue(l,e,i,s)}setValue(t,e,i,s){e>this.width||i>this.height||e<0||i<0||(t[e+i*this.width]=s)}fillLayerWithValue(t,e){const i=[];for(let s=0;s<this.width*this.height;s++)i.push(e);this.layers[t]=i}hide(){this.visibleCanvas.style.display="none"}show(){this.visibleCanvas.style.display="block"}clear(){const t=this.bufferCanvas.getContext("2d"),e=this.visibleCanvas.getContext("2d");t==null||t.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height),e==null||e.clearRect(0,0,this.visibleCanvas.width,this.visibleCanvas.height),this.layers={}}draw(){const t=this.bufferCanvas.getContext("2d"),e=this.visibleCanvas.getContext("2d");if(!(!t||!e)){t.clearRect(0,0,this.bufferCanvas.width,this.bufferCanvas.height);for(const i in this.layers){const s=this.layers[i];for(let l=0;l<s.length;l++){const r=l%this.width,h=Math.floor(l/this.width),n=s[l];t.fillStyle=n,t.fillRect(this.tileX*(r+1),this.tileY*(h+1),this.tileX,this.tileY)}}e.clearRect(0,0,this.visibleCanvas.width,this.visibleCanvas.height),e.drawImage(this.bufferCanvas,0,0)}}startLayerFade(t,e=1e3,i=10,s=1){const l=this.layers[t];if(!l){console.log("No layer found with name: "+t);return}let r=!0;for(let h=0;h<l.length;h++){let n=l[h];n||(n="#00000000");const o=parseInt(n.slice(-2),16);if(o>0){const c=Math.max(o-10,0),u=n.slice(0,-2)+c.toString(16).padStart(2,"0");l[h]=u,r=!1}}this.emit("draw"),r?delete this.layers[t]:setTimeout(()=>{this.startLayerFade(t)},50),this.draw()}addListener(t,e){let i=this.callbacks[t];i||(i=[]),i.push(e),this.callbacks[t]=i}emit(t){const e=this.callbacks[t];e&&e.forEach(i=>i(this))}disable(){this.visibleCanvas.remove(),this.bufferCanvas.remove()}}const z=20;class Wt extends it{constructor(e,i){super();_(this,"level");_(this,"game");_(this,"statusBar");_(this,"player");_(this,"engine");_(this,"moveMenu");_(this,"overlays");_(this,"triggered",[]);_(this,"currentTriggerTextBox");_(this,"hunterDetect",!1);this.game=e,this.overlays=new he(0,0,F,U),this.level=new ft(i,F-z-2,U-2,0,this.overlays),this.level.x=1,this.level.y=1,this.x=0,this.y=0,this.elements.push(this.level),this.engine=new kt(this.level.scheduler)}draw(e,i=0,s=0){if(super.draw(e,i,s),this.level.type!==O.VAULT&&!this.hunterDetect&&this.level.getBeings().some(r=>r instanceof ot)){console.log("HUNTER_CREATED - ALERT");const r=this.level.getBeings().find(n=>n instanceof ot);if(r.resetMoveListeners(),r&&!r.active()||this.level.type===O.TUTORIAL)return;this.hunterDetect=!0,console.log("depth: "+this.level.player.depth+"  "+this.level.type);var l=`ALERT: %c{${d.LASER_RED}}HUNTER ENTERING FLOOR`;this.player.depth===-1?(r.enableJuggernaut(),l=`ALERT: %c{${d.LASER_RED}}HUNTER ENTERING FLOOR   $$$$$%c{${d.MID_LASER_RED}}JUG%c{${d.LASER_RED}}GER%c{${d.MID_LASER_RED}}NAU%c{${d.LASER_RED}}T MODE $$$$$`):r.disableJuggernaut(),r.addMoveListener(n=>{this.level.player.updateVision(),this.draw(e,i,s)});const h=new B(this.player.x,this.player.y+8,30,5,l,d.WHITE,d.DARK_GREY,!0,0,20);this.elements.push(h),this.currentTriggerTextBox=h,setTimeout(()=>{this.elements.includes(h)&&(this.elements.splice(this.elements.indexOf(h),1),this.currentTriggerTextBox=void 0)},6e3)}}handleEvent(e){var o;var i=!0;const s={};s[M.VK_NUMPAD8]=0,s[M.VK_NUMPAD9]=1,s[M.VK_NUMPAD6]=2,s[M.VK_NUMPAD3]=3,s[M.VK_NUMPAD2]=4,s[M.VK_NUMPAD1]=5,s[M.VK_NUMPAD4]=6,s[M.VK_NUMPAD7]=7,s[M.VK_W]=0,s[M.VK_E]=1,s[M.VK_D]=2,s[M.VK_C]=3,s[M.VK_X]=4,s[M.VK_Z]=5,s[M.VK_A]=6,s[M.VK_Q]=7;var l=e.keyCode;if(console.log("CODE: "+l),l>=M.VK_A&&l<=M.VK_Z?this.level.lastKeyStyle="letters":l>=M.VK_NUMPAD0&&l<=M.VK_NUMPAD9&&(this.level.lastKeyStyle="keypad"),console.log("lastKeyStyle: "+this.level.lastKeyStyle),(o=this.player)!=null&&o.getSelectedMove()){if(e.keyCode==M.VK_NUMPAD5||e.keyCode==M.VK_S){this.level.player.deselectMoves();return}else if(l>=M.VK_1&&l<=M.VK_9){this.level.player.deselectMoves();return}else if(l in s){var r=!1;this.level.lastKeyStyle==="letters"?r=this.level.player.selectMove(String.fromCharCode(l)):this.level.lastKeyStyle==="keypad"&&(r=this.level.player.selectMove((l-M.VK_NUMPAD0).toString())),i=r,this.engine&&i&&(console.log("releasing lock"),this.engine.unlock());return}}if(e.keyCode==M.VK_NUMPAD5||e.keyCode==M.VK_S){console.log(`[player @${this.level.player.getPosition().x},${this.level.player.getPosition().y}] wait`);const c=this.level.player.getPosition();for(let u=-1;u<=1;u++)for(let f=-1;f<=1;f++){if(u===0&&f===0)continue;const p=this.level.map.getTile(c.x+u,c.y+f);p&&"interact"in p&&p.interact(this.level.player)}this.level.player.move(0,0)}else if(l>=M.VK_1&&l<=M.VK_9)console.log("move key pressed"),i=this.level.player.selectMove((l-M.VK_1).toString());else if(l in s){var h=P[8][s[l]];console.log(`[player @${this.level.player.getPosition().x},${this.level.player.getPosition().y}] move: ${h[0]},${h[1]}`),this.level.player.move(h[0],h[1])||(i=!1),this.level.player.deselectMoves()}else l==M.VK_ESCAPE&&(this.level.player.deselectMoves(),i=!1);this.level.player.updateVision();const n=this.level.map.getTile(this.level.player.x,this.level.player.y);n&&n.symbol==="%"&&n.enabled&&(console.log("player on exit "+JSON.stringify(n)),this.advanceDepth()),this.engine&&i?(console.log("releasing lock"),this.engine.unlock()):console.log("holding lock"),this.game.refreshDisplay()}advanceDepth(){if(this.triggered=[],this.level.player.depth++,this.hunterDetect=!1,console.log("ADVANCING TO DEPTH: "+this.level.player.depth),this.level.player.depth>=0)this.game.switchState(N.WINSCREEN);else{this.level.disable();var e;this.level.player.depth>=-3?e=new ft(O.EDGE_ROOM,F-z-2,U-2,this.level.player.depth+3,this.overlays):e=new ft(O.VAULT,F-z-2,U-2,this.level.player.depth+3,this.overlays),e.x=1,e.y=1,this.elements=[],this.level=e,this.elements=[this.level,this.statusBar,this.moveMenu];const i=this.level.map.getAllTiles().find(s=>s.type==="ENTRANCE");i||console.error("No entrance tile found."),this.player.setPosition(i),this.player.resetCooldowns(),this.level.setPlayer(this.player),this.player.updateVision(),this.game.refreshDisplay(),this.engine=new kt(this.level.scheduler),this.engine.start(),this.engine.lock()}}setPlayer(e){console.log("SETTING PLAYER"),this.player=e;const i=this.level.getEmptyPoints();if(!i){console.error("No free cells to place player.");return}const s=i[Math.floor(Math.random()*i.length)];e.setPosition(s),this.level.setPlayer(e),this.statusBar?this.statusBar.player=e:(this.statusBar=new fi(this.width-z,this.height-1,z,1,e),this.elements.push(this.statusBar)),this.moveMenu?this.moveMenu.setPlayer(e):(this.moveMenu=new Ti(0,0,e),this.moveMenu.x=this.width-z,this.moveMenu.y=0,this.moveMenu.width=z,this.moveMenu.height=this.height-1,this.elements.push(this.moveMenu)),this.player.addListener("act",l=>{this.engine.lock()}),this.player.addListener("death",l=>{this.game.switchState(N.KILLSCREEN)}),this.player.addListener("move",l=>{const r=this.level.map.getTile(this.player.x,this.player.y);if(r&&r.triggerMetadata){const h=r.triggerMetadata;if(!this.triggered.includes(h.trigger)){this.currentTriggerTextBox&&this.elements.splice(this.elements.indexOf(this.currentTriggerTextBox),1),this.triggered.push(h.trigger);const n=new B(this.player.x,this.player.y+8,30,5,h.text,d.WHITE,d.DARK_GREY,!1,0,20);this.elements.push(n),this.currentTriggerTextBox=n,setTimeout(()=>{this.elements.includes(n)&&(this.elements.splice(this.elements.indexOf(n),1),this.currentTriggerTextBox=void 0)},1e4),h.trigger==="A"&&this.level.activateHunter(),h.trigger==="B"&&this.level.showObjectivePathOverlays()}}})}}class wi extends it{constructor(){super();_(this,"player");_(this,"hunter");this.elements.push(new B(4,2,20,5,"RUNNER",d.MOVE_LIGHT_BLUE,d.BLACK,!0,0,50)),this.elements.push(new B(4,3,20,5,"------",d.WHITE,d.WHITE,!0,0,50)),this.elements.push(new B(5,5,40,5,"a cyberpunk escape roguelike",d.WHITE,d.BLACK,!0,50*6,25)),this.elements.push(new B(5,6,20,5,"by drew harry",d.WHITE,d.BLACK,!0,50*6,25)),this.elements.push(new B(4,this.height-4,40,5,`  press %c{${d.MOVE_LIGHT_BLUE}}any key%c{} to play`,d.WHITE,d.BLACK,!0,50*6,25)),this.elements.push(new B(4,this.height-3,40,5,"  press [t] to tutorial",d.WHITE,d.BLACK,!0,50*6,25)),this.player=new Dt(5,20,"@",d.YELLOW,d.BLACK),this.hunter=new Dt(0,20,"H",d.WHITE,d.LASER_RED),this.disabled=!1}draw(e,i=0,s=0){if(e.clear(),super.draw(e,i,s),this.drawBackground(e,i,s),this.disabled)return;var l=1;const r=Math.floor(Math.random()*3)-1;this.player.move(l,r),e.draw(this.player.x+i,this.player.y+s,this.player.symbol,this.player.fg,this.player.bg),this.player.x>this.width&&(this.player.x=0),this.drawHunter(l,r,e,i,s),setTimeout(()=>{this.disabled||(this.drawHunter(l,r,e,i,s),this.hunter.move(l,r),this.hunter.x>this.width&&(this.hunter.x=0))},200),this.disabled||setTimeout(()=>{this.disabled||this.draw(e,i,s)},250)}drawBackground(e,i=0,s=0){for(let l=0;l<this.width;l++){e.draw(l+i,s+15,"#",d.MID_GREY,d.WHITE),e.draw(l+i,this.height+s-15,"#",d.MID_GREY,d.WHITE);for(let r=16;r<this.height-15;r++)e.draw(l+i,r+s,".",d.WHITE,d.BLACK)}}drawHunter(e,i,s,l=0,r=0){if(!this.disabled){s.draw(this.hunter.x+l,this.hunter.y+r,this.hunter.symbol,d.WHITE,d.LASER_RED);for(let o=-2;o<3;o++)for(let c=-2;c<3;c++){if(o==0&&c==0)continue;const u=Math.sqrt(Math.pow(o,2)+Math.pow(c,2));for(var h=K.fromString(d.LASER_RED),n=0;n<u;n++)h=K.multiply(h,K.fromString("#DDDDDD"));s.draw(this.hunter.x+l+o,this.hunter.y+r+c,"-",K.toRGB(h),K.toRGB(h))}}}handleEvent(e){e.keyCode==M.VK_I}disable(){super.disable()}}class Dt{constructor(t,e,i,s,l){_(this,"x");_(this,"y");_(this,"symbol");_(this,"fg");_(this,"bg");this.x=t,this.y=e,this.symbol=i,this.fg=s,this.bg=l}move(t,e){this.y+e<18||this.y+e>U-18||(this.x+=t,this.y+=e)}act(){this.x+=1}}class xi extends it{constructor(e){super();_(this,"game");_(this,"level");_(this,"levelType");_(this,"overlays");_(this,"difficulty",1);this.game=e,this.levelType=O.EDGE_ROOM,this.overlays=new he(0,0,this.width,this.height),this.overlays.hide(),this.level=this.generateLevelType(this.levelType)}generateLevel(e){const i=O[e];return this.generateLevelType(i)}generateLevelType(e){this.elements.forEach(s=>{s.disable()}),this.elements=[],this.overlays.clear();const i=new ft(e,F-20,U,this.difficulty);return i.map.getAllTiles().forEach(s=>{s.discovered=!0,s.visible=!0}),this.elements.push(i),e===O.EDGE_ROOM&&this.overlays.draw(),this.level=i,i}draw(e,i=0,s=0){super.draw(e,i,s),this.overlays.show()}handleEvent(e){this.level=this.generateLevelType(this.levelType),this.game.refreshDisplay()}disable(){this.overlays.hide(),this.overlays.disable()}}class bi{constructor(){_(this,"display");_(this,"screen",null);_(this,"w",F);_(this,"h",U);_(this,"player",null);_(this,"titleScreen");_(this,"state");_(this,"scheduler",null);_(this,"gameScreen");_(this,"killScreen");_(this,"winScreen");_(this,"mapExploreScreen");_(this,"tutorialScreen");console.log("Game created!"),this.display=new Ne({width:this.w,height:this.h,layout:"rect",forceSquareRatio:!0});const t=this.display.getContainer();document.body.appendChild(t),this.display.getContainer().id="game",window.addEventListener("keydown",this)}init(){this.killScreen=new li,this.titleScreen=new wi,this.winScreen=new ri,this.mapExploreScreen=new xi(this),this.screen=this.titleScreen,this.tutorialScreen=new Wt(this,O.TUTORIAL),this.gameScreen=new Wt(this,O.VAULT),this.state=N.TITLE,this.refreshDisplay(),console.log("Engine started, in locked state for first move.")}refreshDisplay(){this.display.clear();try{this.screen.draw(this.display)}catch(t){console.error("Error drawing screen: "),console.error(t)}}handleEvent(t){switch(this.state){case N.TITLE:if(t.keyCode==M.VK_M)this.switchState(N.MAP_EXPLORE);else if(t.keyCode==M.VK_T){console.log("got T"),this.switchState(N.TUTORIAL);return}else if(t.keyCode!=M.VK_I){this.switchState(N.GAME);return}break;case N.TUTORIAL:case N.GAME:break;case N.KILLSCREEN:window.location.reload();break;case N.WINSCREEN:window.location.reload();break}this.screen.handleEvent(t),this.refreshDisplay()}switchState(t){switch(console.log("Switching to state: "+t+" from "+this.state),this.display.clear(),this.screen.disable(),this.state=t,t){case N.TITLE:this.screen=this.titleScreen;break;case N.GAME:this.player=new Kt,this.gameScreen.setPlayer(this.player),this.player.updateVision(),this.screen=this.gameScreen;break;case N.KILLSCREEN:this.screen=this.killScreen;break;case N.WINSCREEN:this.screen=this.winScreen;break;case N.MAP_EXPLORE:this.screen=this.mapExploreScreen;break;case N.TUTORIAL:this.player=new Kt,this.tutorialScreen.setPlayer(this.player),this.player.updateVision(),this.screen=this.tutorialScreen;break}this.refreshDisplay()}}var vi=new bi;vi.init();
</script>
  </head>
  <body onload="addDownloadButton()" style="background-color: black; margin: 0px">
  </body>
</html>
